import { Injectable } from '@angular/core';
import { OpenVidu, OpenViduErrorName } from 'openvidu-browser';
import { CameraType, DeviceType } from '../../models/device.model';
import * as i0 from "@angular/core";
import * as i1 from "../logger/logger.service";
import * as i2 from "../platform/platform.service";
import * as i3 from "../storage/storage.service";
import * as i4 from "../config/openvidu-angular.config.service";
/**
 * @internal
 */
export class DeviceService {
    constructor(loggerSrv, platformSrv, storageSrv, libSrv) {
        this.loggerSrv = loggerSrv;
        this.platformSrv = platformSrv;
        this.storageSrv = storageSrv;
        this.libSrv = libSrv;
        this.OV = null;
        this.cameras = [];
        this.microphones = [];
        this.videoDevicesEnabled = true;
        this.audioDevicesEnabled = true;
        // Whether the media devices permission have been rejected or not
        this.deviceAccessDeniedError = false;
        this.log = this.loggerSrv.get('DevicesService');
    }
    /**
     * Initialize media devices and select a devices checking in local storage (if exists) or
     * first devices found by default
     */
    async forceInitDevices() {
        this.clear();
        this.OV = new OpenVidu();
        try {
            // if (this.devices?.some((device) => !device.deviceId || !device.label)) {
            // Forcing media permissions request.
            // Sometimes, browser doesn't request the media permissions.
            await this.OV.getUserMedia({ audioSource: undefined, videoSource: undefined });
            // }
            this.devices = await this.getOpenViduDevices();
        }
        catch (error) {
            this.deviceAccessDeniedError = error.name === OpenViduErrorName.DEVICE_ACCESS_DENIED;
            if (this.deviceAccessDeniedError) {
                this.disableVideoDevices();
                this.disableAudioDevices();
            }
        }
        finally {
            if (this.deviceAccessDeniedError) {
                this.log.w('Media devices permissions were not granted.');
            }
            else {
                this.initializeCustomDevices();
                this.updateAudioDeviceSelected();
                this.updateVideoDeviceSelected();
                this._isVideoMuted = this.storageSrv.isVideoMuted() || this.libSrv.videoMuted.getValue();
                this._isAudioMuted = this.storageSrv.isAudioMuted() || this.libSrv.audioMuted.getValue();
                this.log.d('Media devices', this.cameras, this.microphones);
            }
        }
    }
    /**
     * Check and update the media devices devices available
     */
    async refreshDevices() {
        if (!this.deviceAccessDeniedError) {
            this.devices = await this.getOpenViduDevices();
            this.initializeCustomDevices();
        }
    }
    initializeCustomDevices(updateSelected = true) {
        const FIRST_POSITION = 0;
        const defaultMicrophones = this.devices.filter((device) => device.kind === DeviceType.AUDIO_INPUT);
        const defaultCameras = this.devices.filter((device) => device.kind === DeviceType.VIDEO_INPUT);
        if (defaultMicrophones.length > 0) {
            this.microphones = [];
            defaultMicrophones.forEach((device) => {
                this.microphones.push({ label: device.label, device: device.deviceId });
            });
        }
        if (defaultCameras.length > 0) {
            this.cameras = [];
            defaultCameras.forEach((device, index) => {
                const myDevice = {
                    label: device.label,
                    device: device.deviceId,
                    type: CameraType.BACK
                };
                if (this.platformSrv.isMobile()) {
                    // We assume front video device has 'front' in its label in Mobile devices
                    if (myDevice.label.toLowerCase().includes(CameraType.FRONT.toLowerCase())) {
                        myDevice.type = CameraType.FRONT;
                    }
                }
                else {
                    // We assume first device is web camera in Browser Desktop
                    if (index === FIRST_POSITION) {
                        myDevice.type = CameraType.FRONT;
                    }
                }
                this.cameras.push(myDevice);
            });
        }
    }
    updateAudioDeviceSelected() {
        // Setting microphone selected
        if (this.microphones.length > 0) {
            const storageMicrophone = this.getMicrophoneFromStogare();
            if (!!storageMicrophone) {
                this.microphoneSelected = storageMicrophone;
            }
            else if (this.microphones.length > 0) {
                if (this.deviceAccessDeniedError && this.microphones.length > 1) {
                    // We assume that the default device is already in use
                    // Assign an alternative device with the aim of avoiding the DEVICE_ALREADY_IN_USE error
                    this.microphoneSelected = this.microphones[1];
                }
                else {
                    this.microphoneSelected = this.microphones[0];
                }
            }
        }
    }
    updateVideoDeviceSelected() {
        // Setting camera selected
        if (this.cameras.length > 0) {
            const storageCamera = this.getCameraFromStorage();
            if (!!storageCamera) {
                this.cameraSelected = storageCamera;
            }
            else if (this.cameras.length > 0) {
                if (this.deviceAccessDeniedError && this.cameras.length > 1) {
                    // We assume that the default device is already in use
                    // Assign an alternative device with the aim of avoiding the DEVICE_ALREADY_IN_USE error
                    this.cameraSelected = this.cameras[1];
                }
                else {
                    this.cameraSelected = this.cameras[0];
                }
            }
        }
    }
    isVideoMuted() {
        return this.hasVideoDeviceAvailable() && this._isVideoMuted;
    }
    isAudioMuted() {
        return this.hasAudioDeviceAvailable() && this._isAudioMuted;
    }
    getCameraSelected() {
        return this.cameraSelected;
    }
    getMicrophoneSelected() {
        return this.microphoneSelected;
    }
    setCameraSelected(deviceField) {
        this.cameraSelected = this.getCameraByDeviceField(deviceField);
        this.saveCameraToStorage(this.cameraSelected);
    }
    setMicSelected(deviceField) {
        this.microphoneSelected = this.getMicrophoneByDeviceField(deviceField);
        this.saveMicrophoneToStorage(this.microphoneSelected);
    }
    needUpdateVideoTrack(newVideoSource) {
        return this.cameraSelected?.device !== newVideoSource;
    }
    needUpdateAudioTrack(newAudioSource) {
        return this.microphoneSelected?.device !== newAudioSource;
    }
    getCameras() {
        return this.cameras;
    }
    getMicrophones() {
        return this.microphones;
    }
    hasVideoDeviceAvailable() {
        return this.videoDevicesEnabled && this.cameras.length > 0;
    }
    hasAudioDeviceAvailable() {
        return this.audioDevicesEnabled && this.microphones.length > 0;
    }
    cameraNeedsMirror(deviceField) {
        return this.getCameraByDeviceField(deviceField)?.type === CameraType.FRONT;
    }
    disableVideoDevices() {
        this.videoDevicesEnabled = false;
    }
    disableAudioDevices() {
        this.audioDevicesEnabled = false;
    }
    clear() {
        this.OV = null;
        this.devices = [];
        this.cameras = [];
        this.microphones = [];
        this.cameraSelected = null;
        this.microphoneSelected = null;
        this.videoDevicesEnabled = true;
        this.audioDevicesEnabled = true;
    }
    getCameraByDeviceField(deviceField) {
        return this.cameras.find((opt) => opt.device === deviceField || opt.label === deviceField);
    }
    getMicrophoneByDeviceField(deviceField) {
        return this.microphones.find((opt) => opt.device === deviceField || opt.label === deviceField);
    }
    getMicrophoneFromStogare() {
        const storageDevice = this.storageSrv.getAudioDevice();
        if (!!storageDevice && this.microphones.some((device) => device.device === storageDevice.device)) {
            return storageDevice;
        }
    }
    getCameraFromStorage() {
        const storageDevice = this.storageSrv.getVideoDevice();
        if (!!storageDevice && this.cameras.some((device) => device.device === storageDevice.device)) {
            return storageDevice;
        }
    }
    saveCameraToStorage(cam) {
        this.storageSrv.setVideoDevice(cam);
    }
    saveMicrophoneToStorage(mic) {
        this.storageSrv.setAudioDevice(mic);
    }
    async getOpenViduDevices() {
        let devices = (await this.OV?.getDevices()) || [];
        return devices.filter((d) => !!d.label && !!d.deviceId);
    }
}
DeviceService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.8", ngImport: i0, type: DeviceService, deps: [{ token: i1.LoggerService }, { token: i2.PlatformService }, { token: i3.StorageService }, { token: i4.OpenViduAngularConfigService }], target: i0.ɵɵFactoryTarget.Injectable });
DeviceService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.8", ngImport: i0, type: DeviceService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.8", ngImport: i0, type: DeviceService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.LoggerService }, { type: i2.PlatformService }, { type: i3.StorageService }, { type: i4.OpenViduAngularConfigService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9vcGVudmlkdS1hbmd1bGFyL3NyYy9saWIvc2VydmljZXMvZGV2aWNlL2RldmljZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFVLFFBQVEsRUFBaUIsaUJBQWlCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUV0RixPQUFPLEVBQUUsVUFBVSxFQUFnQixVQUFVLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQzs7Ozs7O0FBUWpGOztHQUVHO0FBSUgsTUFBTSxPQUFPLGFBQWE7SUFrQnpCLFlBQ1MsU0FBd0IsRUFDeEIsV0FBNEIsRUFDNUIsVUFBMEIsRUFDMUIsTUFBb0M7UUFIcEMsY0FBUyxHQUFULFNBQVMsQ0FBZTtRQUN4QixnQkFBVyxHQUFYLFdBQVcsQ0FBaUI7UUFDNUIsZUFBVSxHQUFWLFVBQVUsQ0FBZ0I7UUFDMUIsV0FBTSxHQUFOLE1BQU0sQ0FBOEI7UUFyQnJDLE9BQUUsR0FBb0IsSUFBSSxDQUFDO1FBRTNCLFlBQU8sR0FBbUIsRUFBRSxDQUFDO1FBQzdCLGdCQUFXLEdBQW1CLEVBQUUsQ0FBQztRQUlqQyx3QkFBbUIsR0FBWSxJQUFJLENBQUM7UUFDcEMsd0JBQW1CLEdBQVksSUFBSSxDQUFDO1FBTTVDLGlFQUFpRTtRQUN6RCw0QkFBdUIsR0FBWSxLQUFLLENBQUM7UUFRaEQsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRDs7O09BR0c7SUFDSCxLQUFLLENBQUMsZ0JBQWdCO1FBQ3JCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxRQUFRLEVBQUUsQ0FB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QUNsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERldmljZSwgT3BlblZpZHUsIE9wZW5WaWR1RXJyb3IsIE9wZW5WaWR1RXJyb3JOYW1lIH0gZnJvbSAnb3BlbnZpZHUtYnJvd3Nlcic7XG5cbmltcG9ydCB7IENhbWVyYVR5cGUsIEN1c3RvbURldmljZSwgRGV2aWNlVHlwZSB9IGZyb20gJy4uLy4uL21vZGVscy9kZXZpY2UubW9kZWwnO1xuaW1wb3J0IHsgSUxvZ2dlciB9IGZyb20gJy4uLy4uL21vZGVscy9sb2dnZXIubW9kZWwnO1xuaW1wb3J0IHsgT3BlblZpZHVBbmd1bGFyQ29uZmlnU2VydmljZSB9IGZyb20gJy4uL2NvbmZpZy9vcGVudmlkdS1hbmd1bGFyLmNvbmZpZy5zZXJ2aWNlJztcblxuaW1wb3J0IHsgTG9nZ2VyU2VydmljZSB9IGZyb20gJy4uL2xvZ2dlci9sb2dnZXIuc2VydmljZSc7XG5pbXBvcnQgeyBQbGF0Zm9ybVNlcnZpY2UgfSBmcm9tICcuLi9wbGF0Zm9ybS9wbGF0Zm9ybS5zZXJ2aWNlJztcbmltcG9ydCB7IFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vc3RvcmFnZS9zdG9yYWdlLnNlcnZpY2UnO1xuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5ASW5qZWN0YWJsZSh7XG5cdHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBEZXZpY2VTZXJ2aWNlIHtcblx0cHJpdmF0ZSBPVjogT3BlblZpZHUgfCBudWxsID0gbnVsbDtcblx0cHJpdmF0ZSBkZXZpY2VzOiBEZXZpY2VbXTtcblx0cHJpdmF0ZSBjYW1lcmFzOiBDdXN0b21EZXZpY2VbXSA9IFtdO1xuXHRwcml2YXRlIG1pY3JvcGhvbmVzOiBDdXN0b21EZXZpY2VbXSA9IFtdO1xuXHRwcml2YXRlIGNhbWVyYVNlbGVjdGVkOiBDdXN0b21EZXZpY2UgfCBudWxsO1xuXHRwcml2YXRlIG1pY3JvcGhvbmVTZWxlY3RlZDogQ3VzdG9tRGV2aWNlIHwgbnVsbDtcblx0cHJpdmF0ZSBsb2c6IElMb2dnZXI7XG5cdHByaXZhdGUgdmlkZW9EZXZpY2VzRW5hYmxlZDogYm9vbGVhbiA9IHRydWU7XG5cdHByaXZhdGUgYXVkaW9EZXZpY2VzRW5hYmxlZDogYm9vbGVhbiA9IHRydWU7XG5cblx0Ly8gSW5pdGlhbGl6ZWQgd2l0aCBTdG9yYWdlLlZJREVPX01VVEVEIGluZm8gc2F2ZWQgb24gc3RvcmFnZVxuXHRwcml2YXRlIF9pc1ZpZGVvTXV0ZWQ6IGJvb2xlYW47XG5cdC8vIEluaXRpYWxpemVkIHdpdGggU3RvcmFnZS5BVURJT19NVVRFRCBpbmZvIHNhdmVkIG9uIHN0b3JhZ2Vcblx0cHJpdmF0ZSBfaXNBdWRpb011dGVkOiBib29sZWFuO1xuXHQvLyBXaGV0aGVyIHRoZSBtZWRpYSBkZXZpY2VzIHBlcm1pc3Npb24gaGF2ZSBiZWVuIHJlamVjdGVkIG9yIG5vdFxuXHRwcml2YXRlIGRldmljZUFjY2Vzc0RlbmllZEVycm9yOiBib29sZWFuID0gZmFsc2U7XG5cblx0Y29uc3RydWN0b3IoXG5cdFx0cHJpdmF0ZSBsb2dnZXJTcnY6IExvZ2dlclNlcnZpY2UsXG5cdFx0cHJpdmF0ZSBwbGF0Zm9ybVNydjogUGxhdGZvcm1TZXJ2aWNlLFxuXHRcdHByaXZhdGUgc3RvcmFnZVNydjogU3RvcmFnZVNlcnZpY2UsXG5cdFx0cHJpdmF0ZSBsaWJTcnY6IE9wZW5WaWR1QW5ndWxhckNvbmZpZ1NlcnZpY2Vcblx0KSB7XG5cdFx0dGhpcy5sb2cgPSB0aGlzLmxvZ2dlclNydi5nZXQoJ0RldmljZXNTZXJ2aWNlJyk7XG5cdH1cblxuXHQvKipcblx0ICogSW5pdGlhbGl6ZSBtZWRpYSBkZXZpY2VzIGFuZCBzZWxlY3QgYSBkZXZpY2VzIGNoZWNraW5nIGluIGxvY2FsIHN0b3JhZ2UgKGlmIGV4aXN0cykgb3Jcblx0ICogZmlyc3QgZGV2aWNlcyBmb3VuZCBieSBkZWZhdWx0XG5cdCAqL1xuXHRhc3luYyBmb3JjZUluaXREZXZpY2VzKCkge1xuXHRcdHRoaXMuY2xlYXIoKTtcblx0XHR0aGlzLk9WID0gbmV3IE9wZW5WaWR1KCk7XG5cblx0XHR0cnkge1xuXHRcdFx0Ly8gaWYgKHRoaXMuZGV2aWNlcz8uc29tZSgoZGV2aWNlKSA9PiAhZGV2aWNlLmRldmljZUlkIHx8ICFkZXZpY2UubGFiZWwpKSB7XG5cdFx0XHQvLyBGb3JjaW5nIG1lZGlhIHBlcm1pc3Npb25zIHJlcXVlc3QuXG5cdFx0XHQvLyBTb21ldGltZXMsIGJyb3dzZXIgZG9lc24ndCByZXF1ZXN0IHRoZSBtZWRpYSBwZXJtaXNzaW9ucy5cblx0XHRcdGF3YWl0IHRoaXMuT1YuZ2V0VXNlck1lZGlhKHsgYXVkaW9Tb3VyY2U6IHVuZGVmaW5lZCwgdmlkZW9Tb3VyY2U6IHVuZGVmaW5lZCB9KTtcblx0XHRcdC8vIH1cblx0XHRcdHRoaXMuZGV2aWNlcyA9IGF3YWl0IHRoaXMuZ2V0T3BlblZpZHVEZXZpY2VzKCk7XG5cdFx0fSBjYXRjaCAoZXJyb3IpIHtcblx0XHRcdHRoaXMuZGV2aWNlQWNjZXNzRGVuaWVkRXJyb3IgPSAoPE9wZW5WaWR1RXJyb3I+ZXJyb3IpLm5hbWUgPT09IE9wZW5WaWR1RXJyb3JOYW1lLkRFVklDRV9BQ0NFU1NfREVOSUVEO1xuXHRcdFx0aWYgKHRoaXMuZGV2aWNlQWNjZXNzRGVuaWVkRXJyb3IpIHtcblx0XHRcdFx0dGhpcy5kaXNhYmxlVmlkZW9EZXZpY2VzKCk7XG5cdFx0XHRcdHRoaXMuZGlzYWJsZUF1ZGlvRGV2aWNlcygpO1xuXHRcdFx0fVxuXHRcdH0gZmluYWxseSB7XG5cdFx0XHRpZiAodGhpcy5kZXZpY2VBY2Nlc3NEZW5pZWRFcnJvcikge1xuXHRcdFx0XHR0aGlzLmxvZy53KCdNZWRpYSBkZXZpY2VzIHBlcm1pc3Npb25zIHdlcmUgbm90IGdyYW50ZWQuJyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aGlzLmluaXRpYWxpemVDdXN0b21EZXZpY2VzKCk7XG5cdFx0XHRcdHRoaXMudXBkYXRlQXVkaW9EZXZpY2VTZWxlY3RlZCgpO1xuXHRcdFx0XHR0aGlzLnVwZGF0ZVZpZGVvRGV2aWNlU2VsZWN0ZWQoKTtcblxuXHRcdFx0XHR0aGlzLl9pc1ZpZGVvTXV0ZWQgPSB0aGlzLnN0b3JhZ2VTcnYuaXNWaWRlb011dGVkKCkgfHwgdGhpcy5saWJTcnYudmlkZW9NdXRlZC5nZXRWYWx1ZSgpO1xuXHRcdFx0XHR0aGlzLl9pc0F1ZGlvTXV0ZWQgPSB0aGlzLnN0b3JhZ2VTcnYuaXNBdWRpb011dGVkKCkgfHwgdGhpcy5saWJTcnYuYXVkaW9NdXRlZC5nZXRWYWx1ZSgpO1xuXG5cdFx0XHRcdHRoaXMubG9nLmQoJ01lZGlhIGRldmljZXMnLCB0aGlzLmNhbWVyYXMsIHRoaXMubWljcm9waG9uZXMpO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdC8qKlxuXHQgKiBDaGVjayBhbmQgdXBkYXRlIHRoZSBtZWRpYSBkZXZpY2VzIGRldmljZXMgYXZhaWxhYmxlXG5cdCAqL1xuXHRhc3luYyByZWZyZXNoRGV2aWNlcygpIHtcblx0XHRpZiAoIXRoaXMuZGV2aWNlQWNjZXNzRGVuaWVkRXJyb3IpIHtcblx0XHRcdHRoaXMuZGV2aWNlcyA9IGF3YWl0IHRoaXMuZ2V0T3BlblZpZHVEZXZpY2VzKCk7XG5cdFx0XHR0aGlzLmluaXRpYWxpemVDdXN0b21EZXZpY2VzKCk7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBpbml0aWFsaXplQ3VzdG9tRGV2aWNlcyh1cGRhdGVTZWxlY3RlZDogYm9vbGVhbiA9IHRydWUpOiB2b2lkIHtcblx0XHRjb25zdCBGSVJTVF9QT1NJVElPTiA9IDA7XG5cdFx0Y29uc3QgZGVmYXVsdE1pY3JvcGhvbmVzOiBEZXZpY2VbXSA9IHRoaXMuZGV2aWNlcy5maWx0ZXIoKGRldmljZSkgPT4gZGV2aWNlLmtpbmQgPT09IERldmljZVR5cGUuQVVESU9fSU5QVVQpO1xuXHRcdGNvbnN0IGRlZmF1bHRDYW1lcmFzOiBEZXZpY2VbXSA9IHRoaXMuZGV2aWNlcy5maWx0ZXIoKGRldmljZSkgPT4gZGV2aWNlLmtpbmQgPT09IERldmljZVR5cGUuVklERU9fSU5QVVQpO1xuXG5cdFx0aWYgKGRlZmF1bHRNaWNyb3Bob25lcy5sZW5ndGggPiAwKSB7XG5cdFx0XHR0aGlzLm1pY3JvcGhvbmVzID0gW107XG5cdFx0XHRkZWZhdWx0TWljcm9waG9uZXMuZm9yRWFjaCgoZGV2aWNlOiBEZXZpY2UpID0+IHtcblx0XHRcdFx0dGhpcy5taWNyb3Bob25lcy5wdXNoKHsgbGFiZWw6IGRldmljZS5sYWJlbCwgZGV2aWNlOiBkZXZpY2UuZGV2aWNlSWQgfSk7XG5cdFx0XHR9KTtcblx0XHR9XG5cblx0XHRpZiAoZGVmYXVsdENhbWVyYXMubGVuZ3RoID4gMCkge1xuXHRcdFx0dGhpcy5jYW1lcmFzID0gW107XG5cdFx0XHRkZWZhdWx0Q2FtZXJhcy5mb3JFYWNoKChkZXZpY2U6IERldmljZSwgaW5kZXg6IG51bWJlcikgPT4ge1xuXHRcdFx0XHRjb25zdCBteURldmljZTogQ3VzdG9tRGV2aWNlID0ge1xuXHRcdFx0XHRcdGxhYmVsOiBkZXZpY2UubGFiZWwsXG5cdFx0XHRcdFx0ZGV2aWNlOiBkZXZpY2UuZGV2aWNlSWQsXG5cdFx0XHRcdFx0dHlwZTogQ2FtZXJhVHlwZS5CQUNLXG5cdFx0XHRcdH07XG5cdFx0XHRcdGlmICh0aGlzLnBsYXRmb3JtU3J2LmlzTW9iaWxlKCkpIHtcblx0XHRcdFx0XHQvLyBXZSBhc3N1bWUgZnJvbnQgdmlkZW8gZGV2aWNlIGhhcyAnZnJvbnQnIGluIGl0cyBsYWJlbCBpbiBNb2JpbGUgZGV2aWNlc1xuXHRcdFx0XHRcdGlmIChteURldmljZS5sYWJlbC50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKENhbWVyYVR5cGUuRlJPTlQudG9Mb3dlckNhc2UoKSkpIHtcblx0XHRcdFx0XHRcdG15RGV2aWNlLnR5cGUgPSBDYW1lcmFUeXBlLkZST05UO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHQvLyBXZSBhc3N1bWUgZmlyc3QgZGV2aWNlIGlzIHdlYiBjYW1lcmEgaW4gQnJvd3NlciBEZXNrdG9wXG5cdFx0XHRcdFx0aWYgKGluZGV4ID09PSBGSVJTVF9QT1NJVElPTikge1xuXHRcdFx0XHRcdFx0bXlEZXZpY2UudHlwZSA9IENhbWVyYVR5cGUuRlJPTlQ7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdHRoaXMuY2FtZXJhcy5wdXNoKG15RGV2aWNlKTtcblx0XHRcdH0pO1xuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgdXBkYXRlQXVkaW9EZXZpY2VTZWxlY3RlZCgpIHtcblx0XHQvLyBTZXR0aW5nIG1pY3JvcGhvbmUgc2VsZWN0ZWRcblx0XHRpZiAodGhpcy5taWNyb3Bob25lcy5sZW5ndGggPiAwKSB7XG5cdFx0XHRjb25zdCBzdG9yYWdlTWljcm9waG9uZSA9IHRoaXMuZ2V0TWljcm9waG9uZUZyb21TdG9nYXJlKCk7XG5cdFx0XHRpZiAoISFzdG9yYWdlTWljcm9waG9uZSkge1xuXHRcdFx0XHR0aGlzLm1pY3JvcGhvbmVTZWxlY3RlZCA9IHN0b3JhZ2VNaWNyb3Bob25lO1xuXHRcdFx0fSBlbHNlIGlmICh0aGlzLm1pY3JvcGhvbmVzLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0aWYgKHRoaXMuZGV2aWNlQWNjZXNzRGVuaWVkRXJyb3IgJiYgdGhpcy5taWNyb3Bob25lcy5sZW5ndGggPiAxKSB7XG5cdFx0XHRcdFx0Ly8gV2UgYXNzdW1lIHRoYXQgdGhlIGRlZmF1bHQgZGV2aWNlIGlzIGFscmVhZHkgaW4gdXNlXG5cdFx0XHRcdFx0Ly8gQXNzaWduIGFuIGFsdGVybmF0aXZlIGRldmljZSB3aXRoIHRoZSBhaW0gb2YgYXZvaWRpbmcgdGhlIERFVklDRV9BTFJFQURZX0lOX1VTRSBlcnJvclxuXHRcdFx0XHRcdHRoaXMubWljcm9waG9uZVNlbGVjdGVkID0gdGhpcy5taWNyb3Bob25lc1sxXTtcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR0aGlzLm1pY3JvcGhvbmVTZWxlY3RlZCA9IHRoaXMubWljcm9waG9uZXNbMF07XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIHVwZGF0ZVZpZGVvRGV2aWNlU2VsZWN0ZWQoKSB7XG5cdFx0Ly8gU2V0dGluZyBjYW1lcmEgc2VsZWN0ZWRcblx0XHRpZiAodGhpcy5jYW1lcmFzLmxlbmd0aCA+IDApIHtcblx0XHRcdGNvbnN0IHN0b3JhZ2VDYW1lcmEgPSB0aGlzLmdldENhbWVyYUZyb21TdG9yYWdlKCk7XG5cdFx0XHRpZiAoISFzdG9yYWdlQ2FtZXJhKSB7XG5cdFx0XHRcdHRoaXMuY2FtZXJhU2VsZWN0ZWQgPSBzdG9yYWdlQ2FtZXJhO1xuXHRcdFx0fSBlbHNlIGlmICh0aGlzLmNhbWVyYXMubGVuZ3RoID4gMCkge1xuXHRcdFx0XHRpZiAodGhpcy5kZXZpY2VBY2Nlc3NEZW5pZWRFcnJvciAmJiB0aGlzLmNhbWVyYXMubGVuZ3RoID4gMSkge1xuXHRcdFx0XHRcdC8vIFdlIGFzc3VtZSB0aGF0IHRoZSBkZWZhdWx0IGRldmljZSBpcyBhbHJlYWR5IGluIHVzZVxuXHRcdFx0XHRcdC8vIEFzc2lnbiBhbiBhbHRlcm5hdGl2ZSBkZXZpY2Ugd2l0aCB0aGUgYWltIG9mIGF2b2lkaW5nIHRoZSBERVZJQ0VfQUxSRUFEWV9JTl9VU0UgZXJyb3Jcblx0XHRcdFx0XHR0aGlzLmNhbWVyYVNlbGVjdGVkID0gdGhpcy5jYW1lcmFzWzFdO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRoaXMuY2FtZXJhU2VsZWN0ZWQgPSB0aGlzLmNhbWVyYXNbMF07XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRpc1ZpZGVvTXV0ZWQoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMuaGFzVmlkZW9EZXZpY2VBdmFpbGFibGUoKSAmJiB0aGlzLl9pc1ZpZGVvTXV0ZWQ7XG5cdH1cblxuXHRpc0F1ZGlvTXV0ZWQoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMuaGFzQXVkaW9EZXZpY2VBdmFpbGFibGUoKSAmJiB0aGlzLl9pc0F1ZGlvTXV0ZWQ7XG5cdH1cblxuXHRnZXRDYW1lcmFTZWxlY3RlZCgpOiBDdXN0b21EZXZpY2UgfCBudWxsIHtcblx0XHRyZXR1cm4gdGhpcy5jYW1lcmFTZWxlY3RlZDtcblx0fVxuXG5cdGdldE1pY3JvcGhvbmVTZWxlY3RlZCgpOiBDdXN0b21EZXZpY2UgfCBudWxsIHtcblx0XHRyZXR1cm4gdGhpcy5taWNyb3Bob25lU2VsZWN0ZWQ7XG5cdH1cblxuXHRzZXRDYW1lcmFTZWxlY3RlZChkZXZpY2VGaWVsZDogYW55KSB7XG5cdFx0dGhpcy5jYW1lcmFTZWxlY3RlZCA9IHRoaXMuZ2V0Q2FtZXJhQnlEZXZpY2VGaWVsZChkZXZpY2VGaWVsZCk7XG5cdFx0dGhpcy5zYXZlQ2FtZXJhVG9TdG9yYWdlKHRoaXMuY2FtZXJhU2VsZWN0ZWQpO1xuXHR9XG5cblx0c2V0TWljU2VsZWN0ZWQoZGV2aWNlRmllbGQ6IGFueSkge1xuXHRcdHRoaXMubWljcm9waG9uZVNlbGVjdGVkID0gdGhpcy5nZXRNaWNyb3Bob25lQnlEZXZpY2VGaWVsZChkZXZpY2VGaWVsZCk7XG5cdFx0dGhpcy5zYXZlTWljcm9waG9uZVRvU3RvcmFnZSh0aGlzLm1pY3JvcGhvbmVTZWxlY3RlZCk7XG5cdH1cblxuXHRuZWVkVXBkYXRlVmlkZW9UcmFjayhuZXdWaWRlb1NvdXJjZTogc3RyaW5nKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMuY2FtZXJhU2VsZWN0ZWQ/LmRldmljZSAhPT0gbmV3VmlkZW9Tb3VyY2U7XG5cdH1cblxuXHRuZWVkVXBkYXRlQXVkaW9UcmFjayhuZXdBdWRpb1NvdXJjZTogc3RyaW5nKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMubWljcm9waG9uZVNlbGVjdGVkPy5kZXZpY2UgIT09IG5ld0F1ZGlvU291cmNlO1xuXHR9XG5cblx0Z2V0Q2FtZXJhcygpOiBDdXN0b21EZXZpY2VbXSB7XG5cdFx0cmV0dXJuIHRoaXMuY2FtZXJhcztcblx0fVxuXG5cdGdldE1pY3JvcGhvbmVzKCk6IEN1c3RvbURldmljZVtdIHtcblx0XHRyZXR1cm4gdGhpcy5taWNyb3Bob25lcztcblx0fVxuXG5cdGhhc1ZpZGVvRGV2aWNlQXZhaWxhYmxlKCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB0aGlzLnZpZGVvRGV2aWNlc0VuYWJsZWQgJiYgdGhpcy5jYW1lcmFzLmxlbmd0aCA+IDA7XG5cdH1cblxuXHRoYXNBdWRpb0RldmljZUF2YWlsYWJsZSgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5hdWRpb0RldmljZXNFbmFibGVkICYmIHRoaXMubWljcm9waG9uZXMubGVuZ3RoID4gMDtcblx0fVxuXG5cdGNhbWVyYU5lZWRzTWlycm9yKGRldmljZUZpZWxkOiBzdHJpbmcpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5nZXRDYW1lcmFCeURldmljZUZpZWxkKGRldmljZUZpZWxkKT8udHlwZSA9PT0gQ2FtZXJhVHlwZS5GUk9OVDtcblx0fVxuXG5cdGRpc2FibGVWaWRlb0RldmljZXMoKSB7XG5cdFx0dGhpcy52aWRlb0RldmljZXNFbmFibGVkID0gZmFsc2U7XG5cdH1cblxuXHRkaXNhYmxlQXVkaW9EZXZpY2VzKCkge1xuXHRcdHRoaXMuYXVkaW9EZXZpY2VzRW5hYmxlZCA9IGZhbHNlO1xuXHR9XG5cblx0Y2xlYXIoKSB7XG5cdFx0dGhpcy5PViA9IG51bGw7XG5cdFx0dGhpcy5kZXZpY2VzID0gW107XG5cdFx0dGhpcy5jYW1lcmFzID0gW107XG5cdFx0dGhpcy5taWNyb3Bob25lcyA9IFtdO1xuXHRcdHRoaXMuY2FtZXJhU2VsZWN0ZWQgPSBudWxsO1xuXHRcdHRoaXMubWljcm9waG9uZVNlbGVjdGVkID0gbnVsbDtcblx0XHR0aGlzLnZpZGVvRGV2aWNlc0VuYWJsZWQgPSB0cnVlO1xuXHRcdHRoaXMuYXVkaW9EZXZpY2VzRW5hYmxlZCA9IHRydWU7XG5cdH1cblxuXHRwcml2YXRlIGdldENhbWVyYUJ5RGV2aWNlRmllbGQoZGV2aWNlRmllbGQ6IGFueSk6IEN1c3RvbURldmljZSB7XG5cdFx0cmV0dXJuIDxDdXN0b21EZXZpY2U+dGhpcy5jYW1lcmFzLmZpbmQoKG9wdDogQ3VzdG9tRGV2aWNlKSA9PiBvcHQuZGV2aWNlID09PSBkZXZpY2VGaWVsZCB8fCBvcHQubGFiZWwgPT09IGRldmljZUZpZWxkKTtcblx0fVxuXG5cdHByaXZhdGUgZ2V0TWljcm9waG9uZUJ5RGV2aWNlRmllbGQoZGV2aWNlRmllbGQ6IGFueSk6IEN1c3RvbURldmljZSB7XG5cdFx0cmV0dXJuIDxDdXN0b21EZXZpY2U+dGhpcy5taWNyb3Bob25lcy5maW5kKChvcHQ6IEN1c3RvbURldmljZSkgPT4gb3B0LmRldmljZSA9PT0gZGV2aWNlRmllbGQgfHwgb3B0LmxhYmVsID09PSBkZXZpY2VGaWVsZCk7XG5cdH1cblxuXHRwcml2YXRlIGdldE1pY3JvcGhvbmVGcm9tU3RvZ2FyZSgpOiBDdXN0b21EZXZpY2UgfCB1bmRlZmluZWQge1xuXHRcdGNvbnN0IHN0b3JhZ2VEZXZpY2U6IEN1c3RvbURldmljZSA9IHRoaXMuc3RvcmFnZVNydi5nZXRBdWRpb0RldmljZSgpO1xuXHRcdGlmICghIXN0b3JhZ2VEZXZpY2UgJiYgdGhpcy5taWNyb3Bob25lcy5zb21lKChkZXZpY2UpID0+IGRldmljZS5kZXZpY2UgPT09IHN0b3JhZ2VEZXZpY2UuZGV2aWNlKSkge1xuXHRcdFx0cmV0dXJuIHN0b3JhZ2VEZXZpY2U7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBnZXRDYW1lcmFGcm9tU3RvcmFnZSgpIHtcblx0XHRjb25zdCBzdG9yYWdlRGV2aWNlOiBDdXN0b21EZXZpY2UgPSB0aGlzLnN0b3JhZ2VTcnYuZ2V0VmlkZW9EZXZpY2UoKTtcblx0XHRpZiAoISFzdG9yYWdlRGV2aWNlICYmIHRoaXMuY2FtZXJhcy5zb21lKChkZXZpY2UpID0+IGRldmljZS5kZXZpY2UgPT09IHN0b3JhZ2VEZXZpY2UuZGV2aWNlKSkge1xuXHRcdFx0cmV0dXJuIHN0b3JhZ2VEZXZpY2U7XG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBzYXZlQ2FtZXJhVG9TdG9yYWdlKGNhbTogQ3VzdG9tRGV2aWNlKSB7XG5cdFx0dGhpcy5zdG9yYWdlU3J2LnNldFZpZGVvRGV2aWNlKGNhbSk7XG5cdH1cblxuXHRwcml2YXRlIHNhdmVNaWNyb3Bob25lVG9TdG9yYWdlKG1pYzogQ3VzdG9tRGV2aWNlKSB7XG5cdFx0dGhpcy5zdG9yYWdlU3J2LnNldEF1ZGlvRGV2aWNlKG1pYyk7XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGdldE9wZW5WaWR1RGV2aWNlcygpOiBQcm9taXNlPERldmljZVtdPiB7XG5cdFx0bGV0IGRldmljZXMgPSAoYXdhaXQgdGhpcy5PVj8uZ2V0RGV2aWNlcygpKSB8fCBbXTtcblx0XHRyZXR1cm4gZGV2aWNlcy5maWx0ZXIoKGQ6IERldmljZSkgPT4gISFkLmxhYmVsICYmICEhZC5kZXZpY2VJZCk7XG5cdH1cbn1cbiJdfQ==