import { ChangeDetectionStrategy, Component, ViewChildren } from '@angular/core';
import { animate, style, transition, trigger } from '@angular/animations';
import { PanelSettingsOptions, PanelType } from '../../models/panel.model';
import * as i0 from "@angular/core";
import * as i1 from "../../services/panel/panel.service";
import * as i2 from "../../services/openvidu/openvidu.service";
import * as i3 from "../../services/participant/participant.service";
import * as i4 from "../../services/caption/caption.service";
import * as i5 from "@angular/common";
import * as i6 from "@angular/material/button";
import * as i7 from "@angular/material/icon";
import * as i8 from "@angular/flex-layout/extended";
/**
 * @internal
 */
export class CaptionsComponent {
    constructor(panelService, openviduService, participantService, captionService, cd) {
        this.panelService = panelService;
        this.openviduService = openviduService;
        this.participantService = participantService;
        this.captionService = captionService;
        this.cd = cd;
        this.captionEvents = [];
        this.DELETE_TIMEOUT = 10 * 1000;
        this.MAX_EVENTS_LIMIT = 3;
    }
    set captionEventRef(captionEventsRef) {
        setTimeout(() => {
            if (captionEventsRef) {
                this.scrollContainer = captionEventsRef;
            }
        }, 0);
    }
    async ngOnInit() {
        this.captionService.setCaptionsEnabled(true);
        this.captionLangSelected = this.captionService.getLangSelected();
        this.session = this.openviduService.getWebcamSession();
        for (const p of this.participantService.getRemoteParticipants()) {
            const stream = p.getCameraConnection().streamManager.stream;
            await this.session.subscribeToSpeechToText(stream, this.captionLangSelected.ISO);
        }
        this.subscribeToCaptionLanguage();
        this.subscribeToPanelToggling();
        this.subscribeToTranscription();
    }
    async ngOnDestroy() {
        this.captionService.setCaptionsEnabled(false);
        if (this.screenSizeSub)
            this.screenSizeSub.unsubscribe();
        if (this.panelTogglingSubscription)
            this.panelTogglingSubscription.unsubscribe();
        this.session.off('speechToTextMessage');
        this.captionEvents = [];
        for (const p of this.participantService.getRemoteParticipants()) {
            const stream = p.getCameraConnection().streamManager.stream;
            await this.session.unsubscribeFromSpeechToText(stream);
        }
    }
    onSettingsCliked() {
        this.panelService.togglePanel(PanelType.SETTINGS, PanelSettingsOptions.CAPTIONS);
    }
    subscribeToTranscription() {
        this.session.on('speechToTextMessage', (event) => {
            clearInterval(this.deleteAllTimeout);
            const { connectionId, data } = event.connection;
            const nickname = this.participantService.getNicknameFromConnectionData(data);
            const color = this.participantService.getRemoteParticipantByConnectionId(connectionId)?.colorProfile || '';
            const caption = {
                connectionId,
                nickname,
                color,
                text: event.text,
                type: event.reason
            };
            this.updateCaption(caption);
            // Delete all events when there are no more events for a period of time
            this.deleteAllEventsAfterDelay(this.DELETE_TIMEOUT);
            this.cd.markForCheck();
        });
    }
    updateCaption(caption) {
        let captionEventsCopy = [...this.captionEvents];
        let eventsNumber = captionEventsCopy.length;
        if (eventsNumber === 0) {
            captionEventsCopy.push(caption);
        }
        else {
            const lastCaption = captionEventsCopy[eventsNumber - 1];
            const sameSpeakerAsAbove = lastCaption.connectionId === caption.connectionId;
            const lastSpeakerHasStoppedTalking = lastCaption.type === 'recognized';
            if (sameSpeakerAsAbove) {
                if (lastSpeakerHasStoppedTalking) {
                    // Add event if different from previous one
                    if (caption.text !== lastCaption.text) {
                        this.deleteFirstEventAfterDelay(this.DELETE_TIMEOUT);
                        captionEventsCopy.push(caption);
                    }
                }
                else {
                    //Updating last 'recognizing' caption
                    lastCaption.text = caption.text;
                    lastCaption.type = caption.type;
                }
            }
            else {
                // Different speaker is talking
                const speakerExists = captionEventsCopy.some((ev) => ev.connectionId === caption.connectionId);
                if (speakerExists) {
                    // Speaker is already showing
                    if (lastSpeakerHasStoppedTalking) {
                        this.deleteFirstEventAfterDelay(this.DELETE_TIMEOUT);
                        captionEventsCopy.push(caption);
                    }
                    else {
                        // There was an interruption. Last event is still being 'recognizing' (speaker is talking)
                        // Update last speaker event.
                        const lastSpeakerCaption = captionEventsCopy.find((cap) => cap.connectionId === caption.connectionId);
                        if (lastSpeakerCaption) {
                            if (lastSpeakerCaption.type === 'recognized') {
                                captionEventsCopy.push(caption);
                            }
                            else {
                                lastSpeakerCaption.text = caption.text;
                                lastSpeakerCaption.type = caption.type;
                            }
                        }
                    }
                }
                else {
                    this.deleteFirstEventAfterDelay(this.DELETE_TIMEOUT);
                    captionEventsCopy.push(caption);
                }
            }
        }
        if (captionEventsCopy.length === this.MAX_EVENTS_LIMIT) {
            clearInterval(this.deleteFirstTimeout);
            captionEventsCopy.shift();
        }
        this.captionEvents = [...captionEventsCopy];
        this.scrollToBottom();
    }
    deleteFirstEventAfterDelay(timeout) {
        this.deleteFirstTimeout = setTimeout(() => {
            this.captionEvents.shift();
            this.cd.markForCheck();
        }, timeout);
    }
    deleteAllEventsAfterDelay(timeout) {
        this.deleteAllTimeout = setTimeout(() => {
            this.captionEvents = [];
            this.cd.markForCheck();
        }, timeout);
    }
    subscribeToCaptionLanguage() {
        this.captionLanguageSubscription = this.captionService.captionLangObs.subscribe((lang) => {
            this.captionLangSelected = lang;
            this.cd.markForCheck();
        });
    }
    subscribeToPanelToggling() {
        this.panelTogglingSubscription = this.panelService.panelOpenedObs.subscribe((ev) => {
            this.settingsPanelOpened = ev.opened;
            setTimeout(() => this.cd.markForCheck(), 300);
        });
    }
    scrollToBottom() {
        setTimeout(() => {
            try {
                this.scrollContainer.forEach((el, index) => {
                    el.nativeElement.scroll({
                        top: this.scrollContainer.get(index)?.nativeElement.scrollHeight,
                        left: 0
                        // behavior: 'smooth'
                    });
                });
            }
            catch (err) { }
        }, 20);
    }
}
CaptionsComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.8", ngImport: i0, type: CaptionsComponent, deps: [{ token: i1.PanelService }, { token: i2.OpenViduService }, { token: i3.ParticipantService }, { token: i4.CaptionService }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Component });
CaptionsComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.2.8", type: CaptionsComponent, selector: "ov-captions", viewQueries: [{ propertyName: "captionEventRef", predicate: ["captionEventElement"], descendants: true }], ngImport: i0, template: "<div class=\"captions-container\" #captionsContainer>\n\t<div\n\t\t*ngIf=\"captionsContainer.offsetWidth >= 600 && !settingsPanelOpened\"\n\t\tclass=\"captions-offset\"\n\t\t[ngClass]=\"{ 'captions-offset': captionsContainer.offsetWidth >= 1000 }\"\n\t>\n\t\t<button (click)=\"onSettingsCliked()\" id=\"caption-settings-btn\" mat-flat-button>\n\t\t\t<mat-icon id=\"subtitle-settings-icon\">settings</mat-icon>\n\t\t\t<span>{{ captionLangSelected.name }}</span>\n\t\t</button>\n\t</div>\n\t<div\n\t\tclass=\"captions-center-container\"\n\t\t[ngClass]=\"{\n\t\t\t'events-one': captionEvents.length === 1,\n\t\t\t'events-two': captionEvents.length === 2,\n\t\t\t'events-three': captionEvents.length === 3,\n\t\t\t'screen-xl': captionsContainer.offsetWidth >= 1000,\n\t\t\t'screen-md': captionsContainer.offsetWidth >= 960 && captionsContainer.offsetWidth < 1000,\n\t\t\t'screen-sm': captionsContainer.offsetWidth >= 600 && captionsContainer.offsetWidth < 960,\n\t\t\t'screen-xs': captionsContainer.offsetWidth < 600\n\t\t}\"\n\t>\n\t\t<div class=\"element\" *ngFor=\"let caption of captionEvents; let i = index\" @captionAnimation>\n\t\t\t<p id=\"speaker\" [ngStyle]=\"{ color: caption.color }\">\n\t\t\t\t{{ caption.nickname }}\n\t\t\t</p>\n\t\t\t<div\n\t\t\t\tid=\"caption-event\"\n\t\t\t\tclass=\"caption-event\"\n\t\t\t\t[ngClass]=\"{ 'going-to-disappear': i === 0 && captionEvents.length === MAX_EVENTS_LIMIT }\"\n\t\t\t\t#captionEventElement\n\t\t\t>\n\t\t\t\t<span id=\"caption-text\" class=\"caption-text\">{{ caption.text }}</span>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n\t<div *ngIf=\"captionsContainer.offsetWidth >= 600 && !settingsPanelOpened\" class=\"captions-offset\"></div>\n</div>\n", styles: [".captions-container{display:flex;height:var(--ov-captions-height, 230px);margin:0 10px}.captions-offset{height:var(--ov-captions-height, 230px);width:15%;text-align:center}.captions-offset-xl{width:25%!important}.captions-center-container{flex-grow:1;align-self:center;max-height:var(--ov-captions-height, 230px);width:70%;overflow:hidden;height:var(--ov-captions-height, 230px);padding:0px 10vw}.captions-center-container.screen-xl{padding:0px 14vw}.captions-center-container.screen-xl .caption-event>span{font-size:22px}.captions-center-container.screen-xl #speaker{font-size:16px}.captions-center-container.screen-xl.events-one .caption-event{max-height:140px}.captions-center-container.screen-xl.events-two .caption-event{max-height:69px}.captions-center-container.screen-xl.events-three .caption-event{max-height:35px}.captions-center-container.screen-md .caption-event>span{font-size:20px}.captions-center-container.screen-md #speaker{font-size:14px}.captions-center-container.screen-md.events-one .caption-event{max-height:140px}.captions-center-container.screen-md.events-two .caption-event{max-height:69px}.captions-center-container.screen-md.events-three .caption-event{max-height:35px}.captions-center-container.screen-sm{padding:0px 2vw}.captions-center-container.screen-sm .caption-event>span{font-size:20px}.captions-center-container.screen-sm #speaker{font-size:12px}.captions-center-container.screen-sm.events-one .caption-event{max-height:127px}.captions-center-container.screen-sm.events-two .caption-event{max-height:64px}.captions-center-container.screen-sm.events-three .caption-event{max-height:33px}.captions-center-container.screen-xs{padding:0px 2vw}.captions-center-container.screen-xs .caption-event>span{font-size:20px}.captions-center-container.screen-xs #speaker{font-size:12px}.captions-center-container.screen-xs.events-one .caption-event{max-height:130px}.captions-center-container.screen-xs.events-two .caption-event{max-height:69px}.captions-center-container.screen-xs.events-three .caption-event{max-height:35px}.captions-center-container .going-to-disappear{max-height:30px!important}#caption-settings-btn{color:var(--ov-text-color);background-color:var(--ov-secondary-color)}#caption-settings-icon{font-size:15px;height:15px;width:15px;padding-right:5px}#speaker{margin-bottom:2px;font-weight:700;margin-left:-5px;width:fit-content}.captions-center-container .element{margin:8px 0}.caption-event{overflow:auto;pointer-events:none}.caption-text,#speaker{color:var(--ov-text-color);font-family:Roboto,arial,sans-serif}.caption-text{background-color:var(--ov-logo-background-color);padding:4.5px;line-height:1.6;word-break:break-word}::-webkit-scrollbar{display:none}\n"], dependencies: [{ kind: "directive", type: i5.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: i5.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i5.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i5.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }, { kind: "component", type: i6.MatButton, selector: "button[mat-button], button[mat-raised-button], button[mat-icon-button],             button[mat-fab], button[mat-mini-fab], button[mat-stroked-button],             button[mat-flat-button]", inputs: ["disabled", "disableRipple", "color"], exportAs: ["matButton"] }, { kind: "component", type: i7.MatIcon, selector: "mat-icon", inputs: ["color", "inline", "svgIcon", "fontSet", "fontIcon"], exportAs: ["matIcon"] }, { kind: "directive", type: i8.DefaultClassDirective, selector: "  [ngClass], [ngClass.xs], [ngClass.sm], [ngClass.md], [ngClass.lg], [ngClass.xl],  [ngClass.lt-sm], [ngClass.lt-md], [ngClass.lt-lg], [ngClass.lt-xl],  [ngClass.gt-xs], [ngClass.gt-sm], [ngClass.gt-md], [ngClass.gt-lg]", inputs: ["ngClass", "ngClass.xs", "ngClass.sm", "ngClass.md", "ngClass.lg", "ngClass.xl", "ngClass.lt-sm", "ngClass.lt-md", "ngClass.lt-lg", "ngClass.lt-xl", "ngClass.gt-xs", "ngClass.gt-sm", "ngClass.gt-md", "ngClass.gt-lg"] }, { kind: "directive", type: i8.DefaultStyleDirective, selector: "  [ngStyle],  [ngStyle.xs], [ngStyle.sm], [ngStyle.md], [ngStyle.lg], [ngStyle.xl],  [ngStyle.lt-sm], [ngStyle.lt-md], [ngStyle.lt-lg], [ngStyle.lt-xl],  [ngStyle.gt-xs], [ngStyle.gt-sm], [ngStyle.gt-md], [ngStyle.gt-lg]", inputs: ["ngStyle", "ngStyle.xs", "ngStyle.sm", "ngStyle.md", "ngStyle.lg", "ngStyle.xl", "ngStyle.lt-sm", "ngStyle.lt-md", "ngStyle.lt-lg", "ngStyle.lt-xl", "ngStyle.gt-xs", "ngStyle.gt-sm", "ngStyle.gt-md", "ngStyle.gt-lg"] }], animations: [
        trigger('captionAnimation', [
            transition(':enter', [style({ opacity: 0 }), animate('50ms ease-in', style({ opacity: 1 }))])
            // transition(':leave', [style({ opacity: 1 }), animate('10ms ease-out', style({ opacity: 0 }))])
        ])
    ], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.8", ngImport: i0, type: CaptionsComponent, decorators: [{
            type: Component,
            args: [{ selector: 'ov-captions', animations: [
                        trigger('captionAnimation', [
                            transition(':enter', [style({ opacity: 0 }), animate('50ms ease-in', style({ opacity: 1 }))])
                            // transition(':leave', [style({ opacity: 1 }), animate('10ms ease-out', style({ opacity: 0 }))])
                        ])
                    ], changeDetection: ChangeDetectionStrategy.OnPush, template: "<div class=\"captions-container\" #captionsContainer>\n\t<div\n\t\t*ngIf=\"captionsContainer.offsetWidth >= 600 && !settingsPanelOpened\"\n\t\tclass=\"captions-offset\"\n\t\t[ngClass]=\"{ 'captions-offset': captionsContainer.offsetWidth >= 1000 }\"\n\t>\n\t\t<button (click)=\"onSettingsCliked()\" id=\"caption-settings-btn\" mat-flat-button>\n\t\t\t<mat-icon id=\"subtitle-settings-icon\">settings</mat-icon>\n\t\t\t<span>{{ captionLangSelected.name }}</span>\n\t\t</button>\n\t</div>\n\t<div\n\t\tclass=\"captions-center-container\"\n\t\t[ngClass]=\"{\n\t\t\t'events-one': captionEvents.length === 1,\n\t\t\t'events-two': captionEvents.length === 2,\n\t\t\t'events-three': captionEvents.length === 3,\n\t\t\t'screen-xl': captionsContainer.offsetWidth >= 1000,\n\t\t\t'screen-md': captionsContainer.offsetWidth >= 960 && captionsContainer.offsetWidth < 1000,\n\t\t\t'screen-sm': captionsContainer.offsetWidth >= 600 && captionsContainer.offsetWidth < 960,\n\t\t\t'screen-xs': captionsContainer.offsetWidth < 600\n\t\t}\"\n\t>\n\t\t<div class=\"element\" *ngFor=\"let caption of captionEvents; let i = index\" @captionAnimation>\n\t\t\t<p id=\"speaker\" [ngStyle]=\"{ color: caption.color }\">\n\t\t\t\t{{ caption.nickname }}\n\t\t\t</p>\n\t\t\t<div\n\t\t\t\tid=\"caption-event\"\n\t\t\t\tclass=\"caption-event\"\n\t\t\t\t[ngClass]=\"{ 'going-to-disappear': i === 0 && captionEvents.length === MAX_EVENTS_LIMIT }\"\n\t\t\t\t#captionEventElement\n\t\t\t>\n\t\t\t\t<span id=\"caption-text\" class=\"caption-text\">{{ caption.text }}</span>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\n\t<div *ngIf=\"captionsContainer.offsetWidth >= 600 && !settingsPanelOpened\" class=\"captions-offset\"></div>\n</div>\n", styles: [".captions-container{display:flex;height:var(--ov-captions-height, 230px);margin:0 10px}.captions-offset{height:var(--ov-captions-height, 230px);width:15%;text-align:center}.captions-offset-xl{width:25%!important}.captions-center-container{flex-grow:1;align-self:center;max-height:var(--ov-captions-height, 230px);width:70%;overflow:hidden;height:var(--ov-captions-height, 230px);padding:0px 10vw}.captions-center-container.screen-xl{padding:0px 14vw}.captions-center-container.screen-xl .caption-event>span{font-size:22px}.captions-center-container.screen-xl #speaker{font-size:16px}.captions-center-container.screen-xl.events-one .caption-event{max-height:140px}.captions-center-container.screen-xl.events-two .caption-event{max-height:69px}.captions-center-container.screen-xl.events-three .caption-event{max-height:35px}.captions-center-container.screen-md .caption-event>span{font-size:20px}.captions-center-container.screen-md #speaker{font-size:14px}.captions-center-container.screen-md.events-one .caption-event{max-height:140px}.captions-center-container.screen-md.events-two .caption-event{max-height:69px}.captions-center-container.screen-md.events-three .caption-event{max-height:35px}.captions-center-container.screen-sm{padding:0px 2vw}.captions-center-container.screen-sm .caption-event>span{font-size:20px}.captions-center-container.screen-sm #speaker{font-size:12px}.captions-center-container.screen-sm.events-one .caption-event{max-height:127px}.captions-center-container.screen-sm.events-two .caption-event{max-height:64px}.captions-center-container.screen-sm.events-three .caption-event{max-height:33px}.captions-center-container.screen-xs{padding:0px 2vw}.captions-center-container.screen-xs .caption-event>span{font-size:20px}.captions-center-container.screen-xs #speaker{font-size:12px}.captions-center-container.screen-xs.events-one .caption-event{max-height:130px}.captions-center-container.screen-xs.events-two .caption-event{max-height:69px}.captions-center-container.screen-xs.events-three .caption-event{max-height:35px}.captions-center-container .going-to-disappear{max-height:30px!important}#caption-settings-btn{color:var(--ov-text-color);background-color:var(--ov-secondary-color)}#caption-settings-icon{font-size:15px;height:15px;width:15px;padding-right:5px}#speaker{margin-bottom:2px;font-weight:700;margin-left:-5px;width:fit-content}.captions-center-container .element{margin:8px 0}.caption-event{overflow:auto;pointer-events:none}.caption-text,#speaker{color:var(--ov-text-color);font-family:Roboto,arial,sans-serif}.caption-text{background-color:var(--ov-logo-background-color);padding:4.5px;line-height:1.6;word-break:break-word}::-webkit-scrollbar{display:none}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.PanelService }, { type: i2.OpenViduService }, { type: i3.ParticipantService }, { type: i4.CaptionService }, { type: i0.ChangeDetectorRef }]; }, propDecorators: { captionEventRef: [{
                type: ViewChildren,
                args: ['captionEventElement']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FwdGlvbnMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvb3BlbnZpZHUtYW5ndWxhci9zcmMvbGliL2NvbXBvbmVudHMvY2FwdGlvbnMvY2FwdGlvbnMuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvb3BlbnZpZHUtYW5ndWxhci9zcmMvbGliL2NvbXBvbmVudHMvY2FwdGlvbnMvY2FwdGlvbnMuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLHVCQUF1QixFQUFxQixTQUFTLEVBQWlDLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUluSSxPQUFPLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFHMUUsT0FBTyxFQUFFLG9CQUFvQixFQUFFLFNBQVMsRUFBRSxNQUFNLDBCQUEwQixDQUFDOzs7Ozs7Ozs7O0FBSzNFOztHQUVHO0FBYUgsTUFBTSxPQUFPLGlCQUFpQjtJQTRCN0IsWUFDUyxZQUEwQixFQUMxQixlQUFnQyxFQUNoQyxrQkFBc0MsRUFDdEMsY0FBOEIsRUFDOUIsRUFBcUI7UUFKckIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ2hDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLE9BQUUsR0FBRixFQUFFLENBQW1CO1FBbkI5QixrQkFBYSxHQUFtQixFQUFFLENBQUM7UUFPM0IsbUJBQWMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQzNCLHFCQUFnQixHQUFHLENBQUMsQ0FBQztJQVkxQixDQUFDO0lBL0JKLElBQ0ksZUFBZSxDQUFDLGdCQUF1QztRQUMxRCxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ2YsSUFB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O3FCQUNGLG1CQUNnQix1QkFBdUIsQ0FBQyxNQUFNOytOQU0zQyxlQUFlO3NCQURsQixZQUFZO3VCQUFDLHFCQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBPbkluaXQsIFF1ZXJ5TGlzdCwgVmlld0NoaWxkcmVuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IFBhbmVsRXZlbnQsIFBhbmVsU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BhbmVsL3BhbmVsLnNlcnZpY2UnO1xuXG5pbXBvcnQgeyBhbmltYXRlLCBzdHlsZSwgdHJhbnNpdGlvbiwgdHJpZ2dlciB9IGZyb20gJ0Bhbmd1bGFyL2FuaW1hdGlvbnMnO1xuaW1wb3J0IHsgU2Vzc2lvbiwgU3BlZWNoVG9UZXh0RXZlbnQgfSBmcm9tICdvcGVudmlkdS1icm93c2VyJztcbmltcG9ydCB7IENhcHRpb25Nb2RlbCB9IGZyb20gJy4uLy4uL21vZGVscy9jYXB0aW9uLm1vZGVsJztcbmltcG9ydCB7IFBhbmVsU2V0dGluZ3NPcHRpb25zLCBQYW5lbFR5cGUgfSBmcm9tICcuLi8uLi9tb2RlbHMvcGFuZWwubW9kZWwnO1xuaW1wb3J0IHsgQ2FwdGlvblNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9jYXB0aW9uL2NhcHRpb24uc2VydmljZSc7XG5pbXBvcnQgeyBPcGVuVmlkdVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9vcGVudmlkdS9vcGVudmlkdS5zZXJ2aWNlJztcbmltcG9ydCB7IFBhcnRpY2lwYW50U2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BhcnRpY2lwYW50L3BhcnRpY2lwYW50LnNlcnZpY2UnO1xuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5AQ29tcG9uZW50KHtcblx0c2VsZWN0b3I6ICdvdi1jYXB0aW9ucycsXG5cdHRlbXBsYXRlVXJsOiAnLi9jYXB0aW9ucy5jb21wb25lbnQuaHRtbCcsXG5cdHN0eWxlVXJsczogWycuL2NhcHRpb25zLmNvbXBvbmVudC5jc3MnXSxcblx0YW5pbWF0aW9uczogW1xuXHRcdHRyaWdnZXIoJ2NhcHRpb25BbmltYXRpb24nLCBbXG5cdFx0XHR0cmFuc2l0aW9uKCc6ZW50ZXInLCBbc3R5bGUoeyBvcGFjaXR5OiAwIH0pLCBhbmltYXRlKCc1MG1zIGVhc2UtaW4nLCBzdHlsZSh7IG9wYWNpdHk6IDEgfSkpXSlcblx0XHRcdC8vIHRyYW5zaXRpb24oJzpsZWF2ZScsIFtzdHlsZSh7IG9wYWNpdHk6IDEgfSksIGFuaW1hdGUoJzEwbXMgZWFzZS1vdXQnLCBzdHlsZSh7IG9wYWNpdHk6IDAgfSkpXSlcblx0XHRdKVxuXHRdLFxuXHRjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaFxufSlcbmV4cG9ydCBjbGFzcyBDYXB0aW9uc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCB7XG5cdHNjcm9sbENvbnRhaW5lcjogUXVlcnlMaXN0PEVsZW1lbnRSZWY+O1xuXG5cdEBWaWV3Q2hpbGRyZW4oJ2NhcHRpb25FdmVudEVsZW1lbnQnKVxuXHRzZXQgY2FwdGlvbkV2ZW50UmVmKGNhcHRpb25FdmVudHNSZWY6IFF1ZXJ5TGlzdDxFbGVtZW50UmVmPikge1xuXHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0aWYgKGNhcHRpb25FdmVudHNSZWYpIHtcblx0XHRcdFx0dGhpcy5zY3JvbGxDb250YWluZXIgPSBjYXB0aW9uRXZlbnRzUmVmO1xuXHRcdFx0fVxuXHRcdH0sIDApO1xuXHR9XG5cblx0c2V0dGluZ3NQYW5lbE9wZW5lZDogYm9vbGVhbjtcblxuXHRjYXB0aW9uRXZlbnRzOiBDYXB0aW9uTW9kZWxbXSA9IFtdO1xuXG5cdHNlc3Npb246IFNlc3Npb247XG5cblx0cHJpdmF0ZSBkZWxldGVGaXJzdFRpbWVvdXQ6IE5vZGVKUy5UaW1lb3V0O1xuXHRwcml2YXRlIGRlbGV0ZUFsbFRpbWVvdXQ6IE5vZGVKUy5UaW1lb3V0O1xuXG5cdHByaXZhdGUgREVMRVRFX1RJTUVPVVQgPSAxMCAqIDEwMDA7XG5cdHByaXZhdGUgTUFYX0VWRU5UU19MSU1JVCA9IDM7XG5cdHByaXZhdGUgY2FwdGlvbkxhbmd1YWdlU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cdHByaXZhdGUgY2FwdGlvbkxhbmdTZWxlY3RlZDogeyBuYW1lOiBzdHJpbmc7IElTTzogc3RyaW5nIH07XG5cdHByaXZhdGUgc2NyZWVuU2l6ZVN1YjogU3Vic2NyaXB0aW9uO1xuXHRwcml2YXRlIHBhbmVsVG9nZ2xpbmdTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIHBhbmVsU2VydmljZTogUGFuZWxTZXJ2aWNlLFxuXHRcdHByaXZhdGUgb3BlbnZpZHVTZXJ2aWNlOiBPcGVuVmlkdVNlcnZpY2UsXG5cdFx0cHJpdmF0ZSBwYXJ0aWNpcGFudFNlcnZpY2U6IFBhcnRpY2lwYW50U2VydmljZSxcblx0XHRwcml2YXRlIGNhcHRpb25TZXJ2aWNlOiBDYXB0aW9uU2VydmljZSxcblx0XHRwcml2YXRlIGNkOiBDaGFuZ2VEZXRlY3RvclJlZlxuXHQpIHt9XG5cblx0YXN5bmMgbmdPbkluaXQoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dGhpcy5jYXB0aW9uU2VydmljZS5zZXRDYXB0aW9uc0VuYWJsZWQodHJ1ZSk7XG5cdFx0dGhpcy5jYXB0aW9uTGFuZ1NlbGVjdGVkID0gdGhpcy5jYXB0aW9uU2VydmljZS5nZXRMYW5nU2VsZWN0ZWQoKTtcblx0XHR0aGlzLnNlc3Npb24gPSB0aGlzLm9wZW52aWR1U2VydmljZS5nZXRXZWJjYW1TZXNzaW9uKCk7XG5cblx0XHRmb3IgKGNvbnN0IHAgb2YgdGhpcy5wYXJ0aWNpcGFudFNlcnZpY2UuZ2V0UmVtb3RlUGFydGljaXBhbnRzKCkpIHtcblx0XHRcdGNvbnN0IHN0cmVhbSA9IHAuZ2V0Q2FtZXJhQ29ubmVjdGlvbigpLnN0cmVhbU1hbmFnZXIuc3RyZWFtO1xuXHRcdFx0YXdhaXQgdGhpcy5zZXNzaW9uLnN1YnNjcmliZVRvU3BlZWNoVG9UZXh0KHN0cmVhbSwgdGhpcy5jYXB0aW9uTGFuZ1NlbGVjdGVkLklTTyk7XG5cdFx0fVxuXG5cdFx0dGhpcy5zdWJzY3JpYmVUb0NhcHRpb25MYW5ndWFnZSgpO1xuXHRcdHRoaXMuc3Vic2NyaWJlVG9QYW5lbFRvZ2dsaW5nKCk7XG5cdFx0dGhpcy5zdWJzY3JpYmVUb1RyYW5zY3JpcHRpb24oKTtcblx0fVxuXG5cdGFzeW5jIG5nT25EZXN0cm95KCkge1xuXHRcdHRoaXMuY2FwdGlvblNlcnZpY2Uuc2V0Q2FwdGlvbnNFbmFibGVkKGZhbHNlKTtcblx0XHRpZiAodGhpcy5zY3JlZW5TaXplU3ViKSB0aGlzLnNjcmVlblNpemVTdWIudW5zdWJzY3JpYmUoKTtcblx0XHRpZiAodGhpcy5wYW5lbFRvZ2dsaW5nU3Vic2NyaXB0aW9uKSB0aGlzLnBhbmVsVG9nZ2xpbmdTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcblx0XHR0aGlzLnNlc3Npb24ub2ZmKCdzcGVlY2hUb1RleHRNZXNzYWdlJyk7XG5cdFx0dGhpcy5jYXB0aW9uRXZlbnRzID0gW107XG5cblx0XHRmb3IgKGNvbnN0IHAgb2YgdGhpcy5wYXJ0aWNpcGFudFNlcnZpY2UuZ2V0UmVtb3RlUGFydGljaXBhbnRzKCkpIHtcblx0XHRcdGNvbnN0IHN0cmVhbSA9IHAuZ2V0Q2FtZXJhQ29ubmVjdGlvbigpLnN0cmVhbU1hbmFnZXIuc3RyZWFtO1xuXHRcdFx0YXdhaXQgdGhpcy5zZXNzaW9uLnVuc3Vic2NyaWJlRnJvbVNwZWVjaFRvVGV4dChzdHJlYW0pO1xuXHRcdH1cblx0fVxuXG5cdG9uU2V0dGluZ3NDbGlrZWQoKSB7XG5cdFx0dGhpcy5wYW5lbFNlcnZpY2UudG9nZ2xlUGFuZWwoUGFuZWxUeXBlLlNFVFRJTkdTLCBQYW5lbFNldHRpbmdzT3B0aW9ucy5DQVBUSU9OUyk7XG5cdH1cblxuXHRwcml2YXRlIHN1YnNjcmliZVRvVHJhbnNjcmlwdGlvbigpIHtcblx0XHR0aGlzLnNlc3Npb24ub24oJ3NwZWVjaFRvVGV4dE1lc3NhZ2UnLCAoZXZlbnQ6IFNwZWVjaFRvVGV4dEV2ZW50KSA9PiB7XG5cdFx0XHRjbGVhckludGVydmFsKHRoaXMuZGVsZXRlQWxsVGltZW91dCk7XG5cdFx0XHRjb25zdCB7IGNvbm5lY3Rpb25JZCwgZGF0YSB9ID0gZXZlbnQuY29ubmVjdGlvbjtcblx0XHRcdGNvbnN0IG5pY2tuYW1lOiBzdHJpbmcgPSB0aGlzLnBhcnRpY2lwYW50U2VydmljZS5nZXROaWNrbmFtZUZyb21Db25uZWN0aW9uRGF0YShkYXRhKTtcblx0XHRcdGNvbnN0IGNvbG9yID0gdGhpcy5wYXJ0aWNpcGFudFNlcnZpY2UuZ2V0UmVtb3RlUGFydGljaXBhbnRCeUNvbm5lY3Rpb25JZChjb25uZWN0aW9uSWQpPy5jb2xvclByb2ZpbGUgfHwgJyc7XG5cblx0XHRcdGNvbnN0IGNhcHRpb246IENhcHRpb25Nb2RlbCA9IHtcblx0XHRcdFx0Y29ubmVjdGlvbklkLFxuXHRcdFx0XHRuaWNrbmFtZSxcblx0XHRcdFx0Y29sb3IsXG5cdFx0XHRcdHRleHQ6IGV2ZW50LnRleHQsXG5cdFx0XHRcdHR5cGU6IGV2ZW50LnJlYXNvblxuXHRcdFx0fTtcblx0XHRcdHRoaXMudXBkYXRlQ2FwdGlvbihjYXB0aW9uKTtcblx0XHRcdC8vIERlbGV0ZSBhbGwgZXZlbnRzIHdoZW4gdGhlcmUgYXJlIG5vIG1vcmUgZXZlbnRzIGZvciBhIHBlcmlvZCBvZiB0aW1lXG5cdFx0XHR0aGlzLmRlbGV0ZUFsbEV2ZW50c0FmdGVyRGVsYXkodGhpcy5ERUxFVEVfVElNRU9VVCk7XG5cdFx0XHR0aGlzLmNkLm1hcmtGb3JDaGVjaygpO1xuXHRcdH0pO1xuXHR9XG5cdHByaXZhdGUgdXBkYXRlQ2FwdGlvbihjYXB0aW9uOiBDYXB0aW9uTW9kZWwpOiB2b2lkIHtcblx0XHRsZXQgY2FwdGlvbkV2ZW50c0NvcHkgPSBbLi4udGhpcy5jYXB0aW9uRXZlbnRzXTtcblx0XHRsZXQgZXZlbnRzTnVtYmVyID0gY2FwdGlvbkV2ZW50c0NvcHkubGVuZ3RoO1xuXG5cdFx0aWYgKGV2ZW50c051bWJlciA9PT0gMCkge1xuXHRcdFx0Y2FwdGlvbkV2ZW50c0NvcHkucHVzaChjYXB0aW9uKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc3QgbGFzdENhcHRpb246IENhcHRpb25Nb2RlbCB8IHVuZGVmaW5lZCA9IGNhcHRpb25FdmVudHNDb3B5W2V2ZW50c051bWJlciAtIDFdO1xuXHRcdFx0Y29uc3Qgc2FtZVNwZWFrZXJBc0Fib3ZlOiBib29sZWFuID0gbGFzdENhcHRpb24uY29ubmVjdGlvbklkID09PSBjYXB0aW9uLmNvbm5lY3Rpb25JZDtcblx0XHRcdGNvbnN0IGxhc3RTcGVha2VySGFzU3RvcHBlZFRhbGtpbmcgPSBsYXN0Q2FwdGlvbi50eXBlID09PSAncmVjb2duaXplZCc7XG5cblx0XHRcdGlmIChzYW1lU3BlYWtlckFzQWJvdmUpIHtcblx0XHRcdFx0aWYgKGxhc3RTcGVha2VySGFzU3RvcHBlZFRhbGtpbmcpIHtcblx0XHRcdFx0XHQvLyBBZGQgZXZlbnQgaWYgZGlmZmVyZW50IGZyb20gcHJldmlvdXMgb25lXG5cdFx0XHRcdFx0aWYgKGNhcHRpb24udGV4dCAhPT0gbGFzdENhcHRpb24udGV4dCkge1xuXHRcdFx0XHRcdFx0dGhpcy5kZWxldGVGaXJzdEV2ZW50QWZ0ZXJEZWxheSh0aGlzLkRFTEVURV9USU1FT1VUKTtcblx0XHRcdFx0XHRcdGNhcHRpb25FdmVudHNDb3B5LnB1c2goY2FwdGlvbik7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdC8vVXBkYXRpbmcgbGFzdCAncmVjb2duaXppbmcnIGNhcHRpb25cblx0XHRcdFx0XHRsYXN0Q2FwdGlvbi50ZXh0ID0gY2FwdGlvbi50ZXh0O1xuXHRcdFx0XHRcdGxhc3RDYXB0aW9uLnR5cGUgPSBjYXB0aW9uLnR5cGU7XG5cdFx0XHRcdH1cblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdC8vIERpZmZlcmVudCBzcGVha2VyIGlzIHRhbGtpbmdcblx0XHRcdFx0Y29uc3Qgc3BlYWtlckV4aXN0czogYm9vbGVhbiA9IGNhcHRpb25FdmVudHNDb3B5LnNvbWUoKGV2KSA9PiBldi5jb25uZWN0aW9uSWQgPT09IGNhcHRpb24uY29ubmVjdGlvbklkKTtcblx0XHRcdFx0aWYgKHNwZWFrZXJFeGlzdHMpIHtcblx0XHRcdFx0XHQvLyBTcGVha2VyIGlzIGFscmVhZHkgc2hvd2luZ1xuXHRcdFx0XHRcdGlmIChsYXN0U3BlYWtlckhhc1N0b3BwZWRUYWxraW5nKSB7XG5cdFx0XHRcdFx0XHR0aGlzLmRlbGV0ZUZpcnN0RXZlbnRBZnRlckRlbGF5KHRoaXMuREVMRVRFX1RJTUVPVVQpO1xuXHRcdFx0XHRcdFx0Y2FwdGlvbkV2ZW50c0NvcHkucHVzaChjYXB0aW9uKTtcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0Ly8gVGhlcmUgd2FzIGFuIGludGVycnVwdGlvbi4gTGFzdCBldmVudCBpcyBzdGlsbCBiZWluZyAncmVjb2duaXppbmcnIChzcGVha2VyIGlzIHRhbGtpbmcpXG5cdFx0XHRcdFx0XHQvLyBVcGRhdGUgbGFzdCBzcGVha2VyIGV2ZW50LlxuXHRcdFx0XHRcdFx0Y29uc3QgbGFzdFNwZWFrZXJDYXB0aW9uID0gY2FwdGlvbkV2ZW50c0NvcHkuZmluZCgoY2FwKSA9PiBjYXAuY29ubmVjdGlvbklkID09PSBjYXB0aW9uLmNvbm5lY3Rpb25JZCk7XG5cdFx0XHRcdFx0XHRpZiAobGFzdFNwZWFrZXJDYXB0aW9uKSB7XG5cdFx0XHRcdFx0XHRcdGlmIChsYXN0U3BlYWtlckNhcHRpb24udHlwZSA9PT0gJ3JlY29nbml6ZWQnKSB7XG5cdFx0XHRcdFx0XHRcdFx0Y2FwdGlvbkV2ZW50c0NvcHkucHVzaChjYXB0aW9uKTtcblx0XHRcdFx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRcdFx0XHRsYXN0U3BlYWtlckNhcHRpb24udGV4dCA9IGNhcHRpb24udGV4dDtcblx0XHRcdFx0XHRcdFx0XHRsYXN0U3BlYWtlckNhcHRpb24udHlwZSA9IGNhcHRpb24udHlwZTtcblx0XHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHR0aGlzLmRlbGV0ZUZpcnN0RXZlbnRBZnRlckRlbGF5KHRoaXMuREVMRVRFX1RJTUVPVVQpO1xuXHRcdFx0XHRcdGNhcHRpb25FdmVudHNDb3B5LnB1c2goY2FwdGlvbik7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cblx0XHRpZiAoY2FwdGlvbkV2ZW50c0NvcHkubGVuZ3RoID09PSB0aGlzLk1BWF9FVkVOVFNfTElNSVQpIHtcblx0XHRcdGNsZWFySW50ZXJ2YWwodGhpcy5kZWxldGVGaXJzdFRpbWVvdXQpO1xuXHRcdFx0Y2FwdGlvbkV2ZW50c0NvcHkuc2hpZnQoKTtcblx0XHR9XG5cblx0XHR0aGlzLmNhcHRpb25FdmVudHMgPSBbLi4uY2FwdGlvbkV2ZW50c0NvcHldO1xuXHRcdHRoaXMuc2Nyb2xsVG9Cb3R0b20oKTtcblx0fVxuXG5cdHByaXZhdGUgZGVsZXRlRmlyc3RFdmVudEFmdGVyRGVsYXkodGltZW91dDogbnVtYmVyKSB7XG5cdFx0dGhpcy5kZWxldGVGaXJzdFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdHRoaXMuY2FwdGlvbkV2ZW50cy5zaGlmdCgpO1xuXHRcdFx0dGhpcy5jZC5tYXJrRm9yQ2hlY2soKTtcblx0XHR9LCB0aW1lb3V0KTtcblx0fVxuXG5cdHByaXZhdGUgZGVsZXRlQWxsRXZlbnRzQWZ0ZXJEZWxheSh0aW1lb3V0OiBudW1iZXIpIHtcblx0XHR0aGlzLmRlbGV0ZUFsbFRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcblx0XHRcdHRoaXMuY2FwdGlvbkV2ZW50cyA9IFtdO1xuXHRcdFx0dGhpcy5jZC5tYXJrRm9yQ2hlY2soKTtcblx0XHR9LCB0aW1lb3V0KTtcblx0fVxuXG5cdHByaXZhdGUgc3Vic2NyaWJlVG9DYXB0aW9uTGFuZ3VhZ2UoKSB7XG5cdFx0dGhpcy5jYXB0aW9uTGFuZ3VhZ2VTdWJzY3JpcHRpb24gPSB0aGlzLmNhcHRpb25TZXJ2aWNlLmNhcHRpb25MYW5nT2JzLnN1YnNjcmliZSgobGFuZykgPT4ge1xuXHRcdFx0dGhpcy5jYXB0aW9uTGFuZ1NlbGVjdGVkID0gbGFuZztcblx0XHRcdHRoaXMuY2QubWFya0ZvckNoZWNrKCk7XG5cdFx0fSk7XG5cdH1cblxuXHRwcml2YXRlIHN1YnNjcmliZVRvUGFuZWxUb2dnbGluZygpIHtcblx0XHR0aGlzLnBhbmVsVG9nZ2xpbmdTdWJzY3JpcHRpb24gPSB0aGlzLnBhbmVsU2VydmljZS5wYW5lbE9wZW5lZE9icy5zdWJzY3JpYmUoKGV2OiBQYW5lbEV2ZW50KSA9PiB7XG5cdFx0XHR0aGlzLnNldHRpbmdzUGFuZWxPcGVuZWQgPSBldi5vcGVuZWQ7XG5cdFx0XHRzZXRUaW1lb3V0KCgpID0+IHRoaXMuY2QubWFya0ZvckNoZWNrKCksIDMwMCk7XG5cdFx0fSk7XG5cdH1cblxuXHRwcml2YXRlIHNjcm9sbFRvQm90dG9tKCk6IHZvaWQge1xuXHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0dGhpcy5zY3JvbGxDb250YWluZXIuZm9yRWFjaCgoZWw6IEVsZW1lbnRSZWYsIGluZGV4OiBudW1iZXIpID0+IHtcblx0XHRcdFx0XHRlbC5uYXRpdmVFbGVtZW50LnNjcm9sbCh7XG5cdFx0XHRcdFx0XHR0b3A6IHRoaXMuc2Nyb2xsQ29udGFpbmVyLmdldChpbmRleCk/Lm5hdGl2ZUVsZW1lbnQuc2Nyb2xsSGVpZ2h0LFxuXHRcdFx0XHRcdFx0bGVmdDogMFxuXHRcdFx0XHRcdFx0Ly8gYmVoYXZpb3I6ICdzbW9vdGgnXG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSBjYXRjaCAoZXJyKSB7fVxuXHRcdH0sIDIwKTtcblx0fVxufVxuIiwiPGRpdiBjbGFzcz1cImNhcHRpb25zLWNvbnRhaW5lclwiICNjYXB0aW9uc0NvbnRhaW5lcj5cblx0PGRpdlxuXHRcdCpuZ0lmPVwiY2FwdGlvbnNDb250YWluZXIub2Zmc2V0V2lkdGggPj0gNjAwICYmICFzZXR0aW5nc1BhbmVsT3BlbmVkXCJcblx0XHRjbGFzcz1cImNhcHRpb25zLW9mZnNldFwiXG5cdFx0W25nQ2xhc3NdPVwieyAnY2FwdGlvbnMtb2Zmc2V0JzogY2FwdGlvbnNDb250YWluZXIub2Zmc2V0V2lkdGggPj0gMTAwMCB9XCJcblx0PlxuXHRcdDxidXR0b24gKGNsaWNrKT1cIm9uU2V0dGluZ3NDbGlrZWQoKVwiIGlkPVwiY2FwdGlvbi1zZXR0aW5ncy1idG5cIiBtYXQtZmxhdC1idXR0b24+XG5cdFx0XHQ8bWF0LWljb24gaWQ9XCJzdWJ0aXRsZS1zZXR0aW5ncy1pY29uXCI+c2V0dGluZ3M8L21hdC1pY29uPlxuXHRcdFx0PHNwYW4+e3sgY2FwdGlvbkxhbmdTZWxlY3RlZC5uYW1lIH19PC9zcGFuPlxuXHRcdDwvYnV0dG9uPlxuXHQ8L2Rpdj5cblx0PGRpdlxuXHRcdGNsYXNzPVwiY2FwdGlvbnMtY2VudGVyLWNvbnRhaW5lclwiXG5cdFx0W25nQ2xhc3NdPVwie1xuXHRcdFx0J2V2ZW50cy1vbmUnOiBjYXB0aW9uRXZlbnRzLmxlbmd0aCA9PT0gMSxcblx0XHRcdCdldmVudHMtdHdvJzogY2FwdGlvbkV2ZW50cy5sZW5ndGggPT09IDIsXG5cdFx0XHQnZXZlbnRzLXRocmVlJzogY2FwdGlvbkV2ZW50cy5sZW5ndGggPT09IDMsXG5cdFx0XHQnc2NyZWVuLXhsJzogY2FwdGlvbnNDb250YWluZXIub2Zmc2V0V2lkdGggPj0gMTAwMCxcblx0XHRcdCdzY3JlZW4tbWQnOiBjYXB0aW9uc0NvbnRhaW5lci5vZmZzZXRXaWR0aCA+PSA5NjAgJiYgY2FwdGlvbnNDb250YWluZXIub2Zmc2V0V2lkdGggPCAxMDAwLFxuXHRcdFx0J3NjcmVlbi1zbSc6IGNhcHRpb25zQ29udGFpbmVyLm9mZnNldFdpZHRoID49IDYwMCAmJiBjYXB0aW9uc0NvbnRhaW5lci5vZmZzZXRXaWR0aCA8IDk2MCxcblx0XHRcdCdzY3JlZW4teHMnOiBjYXB0aW9uc0NvbnRhaW5lci5vZmZzZXRXaWR0aCA8IDYwMFxuXHRcdH1cIlxuXHQ+XG5cdFx0PGRpdiBjbGFzcz1cImVsZW1lbnRcIiAqbmdGb3I9XCJsZXQgY2FwdGlvbiBvZiBjYXB0aW9uRXZlbnRzOyBsZXQgaSA9IGluZGV4XCIgQGNhcHRpb25BbmltYXRpb24+XG5cdFx0XHQ8cCBpZD1cInNwZWFrZXJcIiBbbmdTdHlsZV09XCJ7IGNvbG9yOiBjYXB0aW9uLmNvbG9yIH1cIj5cblx0XHRcdFx0e3sgY2FwdGlvbi5uaWNrbmFtZSB9fVxuXHRcdFx0PC9wPlxuXHRcdFx0PGRpdlxuXHRcdFx0XHRpZD1cImNhcHRpb24tZXZlbnRcIlxuXHRcdFx0XHRjbGFzcz1cImNhcHRpb24tZXZlbnRcIlxuXHRcdFx0XHRbbmdDbGFzc109XCJ7ICdnb2luZy10by1kaXNhcHBlYXInOiBpID09PSAwICYmIGNhcHRpb25FdmVudHMubGVuZ3RoID09PSBNQVhfRVZFTlRTX0xJTUlUIH1cIlxuXHRcdFx0XHQjY2FwdGlvbkV2ZW50RWxlbWVudFxuXHRcdFx0PlxuXHRcdFx0XHQ8c3BhbiBpZD1cImNhcHRpb24tdGV4dFwiIGNsYXNzPVwiY2FwdGlvbi10ZXh0XCI+e3sgY2FwdGlvbi50ZXh0IH19PC9zcGFuPlxuXHRcdFx0PC9kaXY+XG5cdFx0PC9kaXY+XG5cdDwvZGl2PlxuXG5cdDxkaXYgKm5nSWY9XCJjYXB0aW9uc0NvbnRhaW5lci5vZmZzZXRXaWR0aCA+PSA2MDAgJiYgIXNldHRpbmdzUGFuZWxPcGVuZWRcIiBjbGFzcz1cImNhcHRpb25zLW9mZnNldFwiPjwvZGl2PlxuPC9kaXY+XG4iXX0=