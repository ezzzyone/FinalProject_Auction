import { Component, EventEmitter, Output } from '@angular/core';
import { PanelType } from '../../../models/panel.model';
import { VideoType } from '../../../models/video-type.model';
import * as i0 from "@angular/core";
import * as i1 from "../../../services/openvidu/openvidu.service";
import * as i2 from "../../../services/panel/panel.service";
import * as i3 from "../../../services/storage/storage.service";
import * as i4 from "../../../services/device/device.service";
import * as i5 from "../../../services/participant/participant.service";
import * as i6 from "../../../services/virtual-background/virtual-background.service";
import * as i7 from "@angular/common";
import * as i8 from "@angular/material/button";
import * as i9 from "@angular/material/icon";
import * as i10 from "@angular/material/form-field";
import * as i11 from "@angular/material/tooltip";
import * as i12 from "@angular/material/select";
import * as i13 from "@angular/material/core";
import * as i14 from "../../../pipes/translate.pipe";
/**
 * @internal
 */
export class VideoDevicesComponent {
    constructor(openviduService, panelService, storageSrv, deviceSrv, participantService, backgroundService) {
        this.openviduService = openviduService;
        this.panelService = panelService;
        this.storageSrv = storageSrv;
        this.deviceSrv = deviceSrv;
        this.participantService = participantService;
        this.backgroundService = backgroundService;
        this.onDeviceSelectorClicked = new EventEmitter();
        this.onVideoMutedClicked = new EventEmitter();
        this.cameras = [];
    }
    async ngOnInit() {
        this.subscribeToParticipantMediaProperties();
        if (this.openviduService.isSessionConnected()) {
            // Updating devices only with session connected
            await this.deviceSrv.refreshDevices();
        }
        this.hasVideoDevices = this.deviceSrv.hasVideoDeviceAvailable();
        if (this.hasVideoDevices) {
            this.cameras = this.deviceSrv.getCameras();
            this.cameraSelected = this.deviceSrv.getCameraSelected();
        }
        if (this.openviduService.isSessionConnected()) {
            this.isVideoMuted = !this.participantService.getLocalParticipant().isCameraVideoActive();
        }
        else {
            this.isVideoMuted = this.deviceSrv.isVideoMuted();
        }
    }
    async ngOnDestroy() {
        this.cameras = [];
        if (this.localParticipantSubscription)
            this.localParticipantSubscription.unsubscribe();
    }
    async toggleCam() {
        this.videoMuteChanging = true;
        const publish = this.isVideoMuted;
        await this.openviduService.publishVideo(publish);
        if (this.isVideoMuted && this.panelService.isExternalPanelOpened()) {
            this.panelService.togglePanel(PanelType.BACKGROUND_EFFECTS);
        }
        this.videoMuteChanging = false;
        this.onVideoMutedClicked.emit(publish);
    }
    async onCameraSelected(event) {
        const videoSource = event?.value;
        // Is New deviceId different from the old one?
        if (this.deviceSrv.needUpdateVideoTrack(videoSource)) {
            const mirror = this.deviceSrv.cameraNeedsMirror(videoSource);
            // Reapply Virtual Background to new Publisher if necessary
            const backgroundSelected = this.backgroundService.backgroundSelected.getValue();
            const isBackgroundApplied = this.backgroundService.isBackgroundApplied();
            if (isBackgroundApplied) {
                await this.backgroundService.removeBackground();
            }
            const pp = { videoSource, audioSource: false, mirror };
            await this.openviduService.replaceTrack(VideoType.CAMERA, pp);
            if (isBackgroundApplied) {
                const bgSelected = this.backgroundService.backgrounds.find((b) => b.id === backgroundSelected);
                if (bgSelected) {
                    await this.backgroundService.applyBackground(bgSelected);
                }
            }
            this.deviceSrv.setCameraSelected(videoSource);
            this.cameraSelected = this.deviceSrv.getCameraSelected();
        }
    }
    subscribeToParticipantMediaProperties() {
        this.localParticipantSubscription = this.participantService.localParticipantObs.subscribe((p) => {
            if (p) {
                this.isVideoMuted = !p.isCameraVideoActive();
                this.storageSrv.setVideoMuted(this.isVideoMuted);
            }
        });
    }
}
VideoDevicesComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.8", ngImport: i0, type: VideoDevicesComponent, deps: [{ token: i1.OpenViduService }, { token: i2.PanelService }, { token: i3.StorageService }, { token: i4.DeviceService }, { token: i5.ParticipantService }, { token: i6.VirtualBackgroundService }], target: i0.ɵɵFactoryTarget.Component });
VideoDevicesComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.2.8", type: VideoDevicesComponent, selector: "ov-video-devices-select", outputs: { onDeviceSelectorClicked: "onDeviceSelectorClicked", onVideoMutedClicked: "onVideoMutedClicked" }, ngImport: i0, template: "<div class=\"device-container-element\">\n\t<button\n\t\tmat-icon-button\n\t\tid=\"camera-button\"\n\t\t[disabled]=\"!hasVideoDevices || videoMuteChanging\"\n\t\t[class.warn-btn]=\"isVideoMuted\"\n\t\t(click)=\"toggleCam()\"\n\t>\n\t\t<mat-icon\n\t\t\t*ngIf=\"!isVideoMuted\"\n\t\t\t[matTooltipDisabled]=\"!hasVideoDevices\"\n\t\t\tmatTooltip=\"{{ 'TOOLBAR.MUTE_VIDEO' | translate }}\"\n\t\t\tid=\"videocam\"\n\t\t>\n\t\t\tvideocam\n\t\t</mat-icon>\n\t\t<mat-icon\n\t\t\t*ngIf=\"isVideoMuted\"\n\t\t\t[matTooltipDisabled]=\"!hasVideoDevices\"\n\t\t\tmatTooltip=\"{{ 'TOOLBAR.UNMUTE_VIDEO' | translate }}\"\n\t\t\tid=\"videocam_off\"\n\t\t>\n\t\t\tvideocam_off\n\t\t</mat-icon>\n\t</button>\n\t<mat-form-field>\n\t\t<mat-label *ngIf=\"hasVideoDevices\">{{ 'PREJOIN.VIDEO_DEVICE' | translate }}</mat-label>\n\t\t<mat-label *ngIf=\"!hasVideoDevices\">{{ 'PREJOIN.NO_VIDEO_DEVICE' | translate }}</mat-label>\n\t\t<mat-select\n\t\t\t[disabled]=\"isVideoMuted || !hasVideoDevices\"\n\t\t\t[value]=\"cameraSelected?.device\"\n\t\t\t(click)=\"onDeviceSelectorClicked.emit()\"\n\t\t\t(selectionChange)=\"onCameraSelected($event)\"\n\t\t>\n\t\t\t<mat-option *ngFor=\"let camera of cameras\" [value]=\"camera.device\">\n\t\t\t\t{{ camera.label }}\n\t\t\t</mat-option>\n\t\t</mat-select>\n\t</mat-form-field>\n</div>\n", styles: ["#camera-button{border-radius:var(--ov-buttons-radius)}.device-container-element mat-form-field{width:100%;margin-top:10px;color:#000}.device-container-element button{margin:auto 10px auto auto}.device-container-element{display:flex}.warn-btn{color:var(--ov-text-color);background-color:var(--ov-warn-color)!important}\n"], dependencies: [{ kind: "directive", type: i7.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i7.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i8.MatButton, selector: "button[mat-button], button[mat-raised-button], button[mat-icon-button],             button[mat-fab], button[mat-mini-fab], button[mat-stroked-button],             button[mat-flat-button]", inputs: ["disabled", "disableRipple", "color"], exportAs: ["matButton"] }, { kind: "component", type: i9.MatIcon, selector: "mat-icon", inputs: ["color", "inline", "svgIcon", "fontSet", "fontIcon"], exportAs: ["matIcon"] }, { kind: "component", type: i10.MatFormField, selector: "mat-form-field", inputs: ["color", "appearance", "hideRequiredMarker", "hintLabel", "floatLabel"], exportAs: ["matFormField"] }, { kind: "directive", type: i10.MatLabel, selector: "mat-label" }, { kind: "directive", type: i11.MatTooltip, selector: "[matTooltip]", exportAs: ["matTooltip"] }, { kind: "component", type: i12.MatSelect, selector: "mat-select", inputs: ["disabled", "disableRipple", "tabIndex"], exportAs: ["matSelect"] }, { kind: "component", type: i13.MatOption, selector: "mat-option", exportAs: ["matOption"] }, { kind: "pipe", type: i14.TranslatePipe, name: "translate" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.8", ngImport: i0, type: VideoDevicesComponent, decorators: [{
            type: Component,
            args: [{ selector: 'ov-video-devices-select', template: "<div class=\"device-container-element\">\n\t<button\n\t\tmat-icon-button\n\t\tid=\"camera-button\"\n\t\t[disabled]=\"!hasVideoDevices || videoMuteChanging\"\n\t\t[class.warn-btn]=\"isVideoMuted\"\n\t\t(click)=\"toggleCam()\"\n\t>\n\t\t<mat-icon\n\t\t\t*ngIf=\"!isVideoMuted\"\n\t\t\t[matTooltipDisabled]=\"!hasVideoDevices\"\n\t\t\tmatTooltip=\"{{ 'TOOLBAR.MUTE_VIDEO' | translate }}\"\n\t\t\tid=\"videocam\"\n\t\t>\n\t\t\tvideocam\n\t\t</mat-icon>\n\t\t<mat-icon\n\t\t\t*ngIf=\"isVideoMuted\"\n\t\t\t[matTooltipDisabled]=\"!hasVideoDevices\"\n\t\t\tmatTooltip=\"{{ 'TOOLBAR.UNMUTE_VIDEO' | translate }}\"\n\t\t\tid=\"videocam_off\"\n\t\t>\n\t\t\tvideocam_off\n\t\t</mat-icon>\n\t</button>\n\t<mat-form-field>\n\t\t<mat-label *ngIf=\"hasVideoDevices\">{{ 'PREJOIN.VIDEO_DEVICE' | translate }}</mat-label>\n\t\t<mat-label *ngIf=\"!hasVideoDevices\">{{ 'PREJOIN.NO_VIDEO_DEVICE' | translate }}</mat-label>\n\t\t<mat-select\n\t\t\t[disabled]=\"isVideoMuted || !hasVideoDevices\"\n\t\t\t[value]=\"cameraSelected?.device\"\n\t\t\t(click)=\"onDeviceSelectorClicked.emit()\"\n\t\t\t(selectionChange)=\"onCameraSelected($event)\"\n\t\t>\n\t\t\t<mat-option *ngFor=\"let camera of cameras\" [value]=\"camera.device\">\n\t\t\t\t{{ camera.label }}\n\t\t\t</mat-option>\n\t\t</mat-select>\n\t</mat-form-field>\n</div>\n", styles: ["#camera-button{border-radius:var(--ov-buttons-radius)}.device-container-element mat-form-field{width:100%;margin-top:10px;color:#000}.device-container-element button{margin:auto 10px auto auto}.device-container-element{display:flex}.warn-btn{color:var(--ov-text-color);background-color:var(--ov-warn-color)!important}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.OpenViduService }, { type: i2.PanelService }, { type: i3.StorageService }, { type: i4.DeviceService }, { type: i5.ParticipantService }, { type: i6.VirtualBackgroundService }]; }, propDecorators: { onDeviceSelectorClicked: [{
                type: Output
            }], onVideoMutedClicked: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlkZW8tZGV2aWNlcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9vcGVudmlkdS1hbmd1bGFyL3NyYy9saWIvY29tcG9uZW50cy9zZXR0aW5ncy92aWRlby1kZXZpY2VzL3ZpZGVvLWRldmljZXMuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvb3BlbnZpZHUtYW5ndWxhci9zcmMvbGliL2NvbXBvbmVudHMvc2V0dGluZ3MvdmlkZW8tZGV2aWNlcy92aWRlby1kZXZpY2VzLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFxQixNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJbkYsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRXhELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7OztBQVE3RDs7R0FFRztBQU1ILE1BQU0sT0FBTyxxQkFBcUI7SUFXakMsWUFDUyxlQUFnQyxFQUM5QixZQUEwQixFQUM1QixVQUEwQixFQUMxQixTQUF3QixFQUN0QixrQkFBc0MsRUFDeEMsaUJBQTJDO1FBTDNDLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQUM5QixpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUM1QixlQUFVLEdBQVYsVUFBVSxDQUFnQjtRQUMxQixjQUFTLEdBQVQsU0FBUyxDQUFlO1FBQ3RCLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDeEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUEwQjtRQWhCekMsNEJBQXVCLEdBQUcsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUNuRCx3QkFBbUIsR0FBRyxJQUFJLFlBQVksRUFBVyxDQUFDO1FBTTdELFlBQU8sR0FBbUIsRUFBRSxDQUFDO0lBVTFCLENBQUM7SUFFSixLQUFLLENBQUMsUUFBUTtRQUNiLElBQUksQ0FBQyxxQ0FBcUMsRUFBRSxDQUFDO1FBQzdDLElBQUksSUFBSSxDQUFDLGVBQWUsQ0FBQyxrQkFBa0IsRUFBRSxFQUFFO1lBQzlDLCtDQUErQztZQUMvQyxNQUFNLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLENBQUM7U0FDdEM7UUFHRCxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztRQUNoRSxJQUFHLElBQUksQ0FBQyxlQUFlLEVBQUM7WUFDdkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQzNDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1NBQ3pEO1FBQ0QsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLGtCQUFrQixFQUFFLEVBQUU7WUFDOUMsSUFBSSxDQUFDLFlBQVksR0FBRyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLG1CQUFtQixFQUFFLENBQUM7U0FDekY7YUFBTTtZQUNOLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsQ0FBQztTQUNsRDtJQUNGLENBQUM7SUFDRCxLQUFLLENBQUMsV0FBVztRQUNoQixJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNsQixJQUFJLElBQUksQ0FBQyw0QkFBNEI7WUFBRSxJQUFJLENBQUMsNEJBQTRCLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDeEYsQ0FBQztJQUVELEtBQUssQ0FBQyxTQUFTO1FBQ2QsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQztRQUM5QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDO1FBQ2xDLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDakQsSUFBSSxJQUFJLENBQUMsWUFBWSxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMscUJBQXFCLEVBQUUsRUFBRTtZQUNuRSxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUM1RDtRQUNELElBQUksQ0FBQyxpQkFBaUIsR0FBRyxLQUFLLENBQUM7UUFDL0IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQsS0FBSyxDQUFDLGdCQUFnQixDQUFDLEtBQVU7UUFDaEMsTUFBTSxXQUFXLEdBQUcsS0FBSyxFQUFFLEtBQUssQ0FBQztRQUNqQyw4Q0FBOEM7UUFDOUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLG9CQUFvQixDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQ3JELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDN0QsMkRBQTJEO1lBQzNELE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ2hGLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLG1CQUFtQixFQUFFLENBQUE7WUFFeEUsSUFBSSxtQkFBbUIsRUFBRTtnQkFDeEIsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQzthQUNoRDtZQUNELE1BQU0sRUFBRSxHQUF3QixFQUFFLFdBQVcsRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUFDO1lBQzVFLE1BQU0sSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztZQUU5RCxJQUFJLG1CQUFtQixFQUFFO2dCQUN4QixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxrQkFBa0IsQ0FBQyxDQUFDO2dCQUMvRixJQUFJLFVBQVUsRUFBRTtvQkFDZixNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLENBQUMsVUFBVSxDQUFDLENBQUM7aUJBQ3pEO2FBQ0Q7WUFFRCxJQUFJLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzlDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1NBQ3pEO0lBQ0YsQ0FBQztJQUVTLHFDQUFxQztRQUM5QyxJQUFJLENBQUMsNEJBQTRCLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLG1CQUFtQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQTJCLEVBQUUsRUFBRTtZQUN6SCxJQUFJLENBQUMsRUFBRTtnQkFDTixJQUFJLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDLG1CQUFtQixFQUFFLENBQUM7Z0JBQzdDLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQzthQUNqRDtRQUNGLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQzs7a0hBekZXLHFCQUFxQjtzR0FBckIscUJBQXFCLDRLQ3RCbEMsNHhDQXdDQTsyRkRsQmEscUJBQXFCO2tCQUxqQyxTQUFTOytCQUNDLHlCQUF5QjtrUUFLeEIsdUJBQXVCO3NCQUFqQyxNQUFNO2dCQUNJLG1CQUFtQjtzQkFBN0IsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBPbkRlc3Ryb3ksIE9uSW5pdCwgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBQdWJsaXNoZXJQcm9wZXJ0aWVzIH0gZnJvbSAnb3BlbnZpZHUtYnJvd3Nlcic7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEN1c3RvbURldmljZSB9IGZyb20gJy4uLy4uLy4uL21vZGVscy9kZXZpY2UubW9kZWwnO1xuaW1wb3J0IHsgUGFuZWxUeXBlIH0gZnJvbSAnLi4vLi4vLi4vbW9kZWxzL3BhbmVsLm1vZGVsJztcbmltcG9ydCB7IFBhcnRpY2lwYW50QWJzdHJhY3RNb2RlbCB9IGZyb20gJy4uLy4uLy4uL21vZGVscy9wYXJ0aWNpcGFudC5tb2RlbCc7XG5pbXBvcnQgeyBWaWRlb1R5cGUgfSBmcm9tICcuLi8uLi8uLi9tb2RlbHMvdmlkZW8tdHlwZS5tb2RlbCc7XG5pbXBvcnQgeyBEZXZpY2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvZGV2aWNlL2RldmljZS5zZXJ2aWNlJztcbmltcG9ydCB7IE9wZW5WaWR1U2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3NlcnZpY2VzL29wZW52aWR1L29wZW52aWR1LnNlcnZpY2UnO1xuaW1wb3J0IHsgUGFuZWxTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvcGFuZWwvcGFuZWwuc2VydmljZSc7XG5pbXBvcnQgeyBQYXJ0aWNpcGFudFNlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlcy9wYXJ0aWNpcGFudC9wYXJ0aWNpcGFudC5zZXJ2aWNlJztcbmltcG9ydCB7IFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvc3RvcmFnZS9zdG9yYWdlLnNlcnZpY2UnO1xuaW1wb3J0IHsgVmlydHVhbEJhY2tncm91bmRTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vc2VydmljZXMvdmlydHVhbC1iYWNrZ3JvdW5kL3ZpcnR1YWwtYmFja2dyb3VuZC5zZXJ2aWNlJztcblxuLyoqXG4gKiBAaW50ZXJuYWxcbiAqL1xuQENvbXBvbmVudCh7XG5cdHNlbGVjdG9yOiAnb3YtdmlkZW8tZGV2aWNlcy1zZWxlY3QnLFxuXHR0ZW1wbGF0ZVVybDogJy4vdmlkZW8tZGV2aWNlcy5jb21wb25lbnQuaHRtbCcsXG5cdHN0eWxlVXJsczogWycuL3ZpZGVvLWRldmljZXMuY29tcG9uZW50LmNzcyddXG59KVxuZXhwb3J0IGNsYXNzIFZpZGVvRGV2aWNlc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcblx0QE91dHB1dCgpICBvbkRldmljZVNlbGVjdG9yQ2xpY2tlZCA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcblx0QE91dHB1dCgpICBvblZpZGVvTXV0ZWRDbGlja2VkID0gbmV3IEV2ZW50RW1pdHRlcjxib29sZWFuPigpO1xuXG5cdHZpZGVvTXV0ZUNoYW5naW5nOiBib29sZWFuO1xuXHRpc1ZpZGVvTXV0ZWQ6IGJvb2xlYW47XG5cdGNhbWVyYVNlbGVjdGVkOiBDdXN0b21EZXZpY2UgfCBudWxsO1xuXHRoYXNWaWRlb0RldmljZXM6IGJvb2xlYW47XG5cdGNhbWVyYXM6IEN1c3RvbURldmljZVtdID0gW107XG5cdGxvY2FsUGFydGljaXBhbnRTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIG9wZW52aWR1U2VydmljZTogT3BlblZpZHVTZXJ2aWNlLFxuXHRcdHByb3RlY3RlZCBwYW5lbFNlcnZpY2U6IFBhbmVsU2VydmljZSxcblx0XHRwcml2YXRlIHN0b3JhZ2VTcnY6IFN0b3JhZ2VTZXJ2aWNlLFxuXHRcdHByaXZhdGUgZGV2aWNlU3J2OiBEZXZpY2VTZXJ2aWNlLFxuXHRcdHByb3RlY3RlZCBwYXJ0aWNpcGFudFNlcnZpY2U6IFBhcnRpY2lwYW50U2VydmljZSxcblx0XHRwcml2YXRlIGJhY2tncm91bmRTZXJ2aWNlOiBWaXJ0dWFsQmFja2dyb3VuZFNlcnZpY2Vcblx0KSB7fVxuXG5cdGFzeW5jIG5nT25Jbml0KCkge1xuXHRcdHRoaXMuc3Vic2NyaWJlVG9QYXJ0aWNpcGFudE1lZGlhUHJvcGVydGllcygpO1xuXHRcdGlmICh0aGlzLm9wZW52aWR1U2VydmljZS5pc1Nlc3Npb25Db25uZWN0ZWQoKSkge1xuXHRcdFx0Ly8gVXBkYXRpbmcgZGV2aWNlcyBvbmx5IHdpdGggc2Vzc2lvbiBjb25uZWN0ZWRcblx0XHRcdGF3YWl0IHRoaXMuZGV2aWNlU3J2LnJlZnJlc2hEZXZpY2VzKCk7XG5cdFx0fVxuXG5cblx0XHR0aGlzLmhhc1ZpZGVvRGV2aWNlcyA9IHRoaXMuZGV2aWNlU3J2Lmhhc1ZpZGVvRGV2aWNlQXZhaWxhYmxlKCk7XG5cdFx0aWYodGhpcy5oYXNWaWRlb0RldmljZXMpe1xuXHRcdFx0dGhpcy5jYW1lcmFzID0gdGhpcy5kZXZpY2VTcnYuZ2V0Q2FtZXJhcygpO1xuXHRcdFx0dGhpcy5jYW1lcmFTZWxlY3RlZCA9IHRoaXMuZGV2aWNlU3J2LmdldENhbWVyYVNlbGVjdGVkKCk7XG5cdFx0fVxuXHRcdGlmICh0aGlzLm9wZW52aWR1U2VydmljZS5pc1Nlc3Npb25Db25uZWN0ZWQoKSkge1xuXHRcdFx0dGhpcy5pc1ZpZGVvTXV0ZWQgPSAhdGhpcy5wYXJ0aWNpcGFudFNlcnZpY2UuZ2V0TG9jYWxQYXJ0aWNpcGFudCgpLmlzQ2FtZXJhVmlkZW9BY3RpdmUoKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5pc1ZpZGVvTXV0ZWQgPSB0aGlzLmRldmljZVNydi5pc1ZpZGVvTXV0ZWQoKTtcblx0XHR9XG5cdH1cblx0YXN5bmMgbmdPbkRlc3Ryb3koKSB7XG5cdFx0dGhpcy5jYW1lcmFzID0gW107XG5cdFx0aWYgKHRoaXMubG9jYWxQYXJ0aWNpcGFudFN1YnNjcmlwdGlvbikgdGhpcy5sb2NhbFBhcnRpY2lwYW50U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG5cdH1cblxuXHRhc3luYyB0b2dnbGVDYW0oKSB7XG5cdFx0dGhpcy52aWRlb011dGVDaGFuZ2luZyA9IHRydWU7XG5cdFx0Y29uc3QgcHVibGlzaCA9IHRoaXMuaXNWaWRlb011dGVkO1xuXHRcdGF3YWl0IHRoaXMub3BlbnZpZHVTZXJ2aWNlLnB1Ymxpc2hWaWRlbyhwdWJsaXNoKTtcblx0XHRpZiAodGhpcy5pc1ZpZGVvTXV0ZWQgJiYgdGhpcy5wYW5lbFNlcnZpY2UuaXNFeHRlcm5hbFBhbmVsT3BlbmVkKCkpIHtcblx0XHRcdHRoaXMucGFuZWxTZXJ2aWNlLnRvZ2dsZVBhbmVsKFBhbmVsVHlwZS5CQUNLR1JPVU5EX0VGRkVDVFMpO1xuXHRcdH1cblx0XHR0aGlzLnZpZGVvTXV0ZUNoYW5naW5nID0gZmFsc2U7XG5cdFx0dGhpcy5vblZpZGVvTXV0ZWRDbGlja2VkLmVtaXQocHVibGlzaCk7XG5cdH1cblxuXHRhc3luYyBvbkNhbWVyYVNlbGVjdGVkKGV2ZW50OiBhbnkpIHtcblx0XHRjb25zdCB2aWRlb1NvdXJjZSA9IGV2ZW50Py52YWx1ZTtcblx0XHQvLyBJcyBOZXcgZGV2aWNlSWQgZGlmZmVyZW50IGZyb20gdGhlIG9sZCBvbmU/XG5cdFx0aWYgKHRoaXMuZGV2aWNlU3J2Lm5lZWRVcGRhdGVWaWRlb1RyYWNrKHZpZGVvU291cmNlKSkge1xuXHRcdFx0Y29uc3QgbWlycm9yID0gdGhpcy5kZXZpY2VTcnYuY2FtZXJhTmVlZHNNaXJyb3IodmlkZW9Tb3VyY2UpO1xuXHRcdFx0Ly8gUmVhcHBseSBWaXJ0dWFsIEJhY2tncm91bmQgdG8gbmV3IFB1Ymxpc2hlciBpZiBuZWNlc3Nhcnlcblx0XHRcdGNvbnN0IGJhY2tncm91bmRTZWxlY3RlZCA9IHRoaXMuYmFja2dyb3VuZFNlcnZpY2UuYmFja2dyb3VuZFNlbGVjdGVkLmdldFZhbHVlKCk7XG5cdFx0XHRjb25zdCBpc0JhY2tncm91bmRBcHBsaWVkID0gdGhpcy5iYWNrZ3JvdW5kU2VydmljZS5pc0JhY2tncm91bmRBcHBsaWVkKClcblxuXHRcdFx0aWYgKGlzQmFja2dyb3VuZEFwcGxpZWQpIHtcblx0XHRcdFx0YXdhaXQgdGhpcy5iYWNrZ3JvdW5kU2VydmljZS5yZW1vdmVCYWNrZ3JvdW5kKCk7XG5cdFx0XHR9XG5cdFx0XHRjb25zdCBwcDogUHVibGlzaGVyUHJvcGVydGllcyA9IHsgdmlkZW9Tb3VyY2UsIGF1ZGlvU291cmNlOiBmYWxzZSwgbWlycm9yIH07XG5cdFx0XHRhd2FpdCB0aGlzLm9wZW52aWR1U2VydmljZS5yZXBsYWNlVHJhY2soVmlkZW9UeXBlLkNBTUVSQSwgcHApO1xuXG5cdFx0XHRpZiAoaXNCYWNrZ3JvdW5kQXBwbGllZCkge1xuXHRcdFx0XHRjb25zdCBiZ1NlbGVjdGVkID0gdGhpcy5iYWNrZ3JvdW5kU2VydmljZS5iYWNrZ3JvdW5kcy5maW5kKChiKSA9PiBiLmlkID09PSBiYWNrZ3JvdW5kU2VsZWN0ZWQpO1xuXHRcdFx0XHRpZiAoYmdTZWxlY3RlZCkge1xuXHRcdFx0XHRcdGF3YWl0IHRoaXMuYmFja2dyb3VuZFNlcnZpY2UuYXBwbHlCYWNrZ3JvdW5kKGJnU2VsZWN0ZWQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdHRoaXMuZGV2aWNlU3J2LnNldENhbWVyYVNlbGVjdGVkKHZpZGVvU291cmNlKTtcblx0XHRcdHRoaXMuY2FtZXJhU2VsZWN0ZWQgPSB0aGlzLmRldmljZVNydi5nZXRDYW1lcmFTZWxlY3RlZCgpO1xuXHRcdH1cblx0fVxuXG5cdHByb3RlY3RlZCBzdWJzY3JpYmVUb1BhcnRpY2lwYW50TWVkaWFQcm9wZXJ0aWVzKCkge1xuXHRcdHRoaXMubG9jYWxQYXJ0aWNpcGFudFN1YnNjcmlwdGlvbiA9IHRoaXMucGFydGljaXBhbnRTZXJ2aWNlLmxvY2FsUGFydGljaXBhbnRPYnMuc3Vic2NyaWJlKChwOiBQYXJ0aWNpcGFudEFic3RyYWN0TW9kZWwpID0+IHtcblx0XHRcdGlmIChwKSB7XG5cdFx0XHRcdHRoaXMuaXNWaWRlb011dGVkID0gIXAuaXNDYW1lcmFWaWRlb0FjdGl2ZSgpO1xuXHRcdFx0XHR0aGlzLnN0b3JhZ2VTcnYuc2V0VmlkZW9NdXRlZCh0aGlzLmlzVmlkZW9NdXRlZCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cbn1cbiIsIjxkaXYgY2xhc3M9XCJkZXZpY2UtY29udGFpbmVyLWVsZW1lbnRcIj5cblx0PGJ1dHRvblxuXHRcdG1hdC1pY29uLWJ1dHRvblxuXHRcdGlkPVwiY2FtZXJhLWJ1dHRvblwiXG5cdFx0W2Rpc2FibGVkXT1cIiFoYXNWaWRlb0RldmljZXMgfHwgdmlkZW9NdXRlQ2hhbmdpbmdcIlxuXHRcdFtjbGFzcy53YXJuLWJ0bl09XCJpc1ZpZGVvTXV0ZWRcIlxuXHRcdChjbGljayk9XCJ0b2dnbGVDYW0oKVwiXG5cdD5cblx0XHQ8bWF0LWljb25cblx0XHRcdCpuZ0lmPVwiIWlzVmlkZW9NdXRlZFwiXG5cdFx0XHRbbWF0VG9vbHRpcERpc2FibGVkXT1cIiFoYXNWaWRlb0RldmljZXNcIlxuXHRcdFx0bWF0VG9vbHRpcD1cInt7ICdUT09MQkFSLk1VVEVfVklERU8nIHwgdHJhbnNsYXRlIH19XCJcblx0XHRcdGlkPVwidmlkZW9jYW1cIlxuXHRcdD5cblx0XHRcdHZpZGVvY2FtXG5cdFx0PC9tYXQtaWNvbj5cblx0XHQ8bWF0LWljb25cblx0XHRcdCpuZ0lmPVwiaXNWaWRlb011dGVkXCJcblx0XHRcdFttYXRUb29sdGlwRGlzYWJsZWRdPVwiIWhhc1ZpZGVvRGV2aWNlc1wiXG5cdFx0XHRtYXRUb29sdGlwPVwie3sgJ1RPT0xCQVIuVU5NVVRFX1ZJREVPJyB8IHRyYW5zbGF0ZSB9fVwiXG5cdFx0XHRpZD1cInZpZGVvY2FtX29mZlwiXG5cdFx0PlxuXHRcdFx0dmlkZW9jYW1fb2ZmXG5cdFx0PC9tYXQtaWNvbj5cblx0PC9idXR0b24+XG5cdDxtYXQtZm9ybS1maWVsZD5cblx0XHQ8bWF0LWxhYmVsICpuZ0lmPVwiaGFzVmlkZW9EZXZpY2VzXCI+e3sgJ1BSRUpPSU4uVklERU9fREVWSUNFJyB8IHRyYW5zbGF0ZSB9fTwvbWF0LWxhYmVsPlxuXHRcdDxtYXQtbGFiZWwgKm5nSWY9XCIhaGFzVmlkZW9EZXZpY2VzXCI+e3sgJ1BSRUpPSU4uTk9fVklERU9fREVWSUNFJyB8IHRyYW5zbGF0ZSB9fTwvbWF0LWxhYmVsPlxuXHRcdDxtYXQtc2VsZWN0XG5cdFx0XHRbZGlzYWJsZWRdPVwiaXNWaWRlb011dGVkIHx8ICFoYXNWaWRlb0RldmljZXNcIlxuXHRcdFx0W3ZhbHVlXT1cImNhbWVyYVNlbGVjdGVkPy5kZXZpY2VcIlxuXHRcdFx0KGNsaWNrKT1cIm9uRGV2aWNlU2VsZWN0b3JDbGlja2VkLmVtaXQoKVwiXG5cdFx0XHQoc2VsZWN0aW9uQ2hhbmdlKT1cIm9uQ2FtZXJhU2VsZWN0ZWQoJGV2ZW50KVwiXG5cdFx0PlxuXHRcdFx0PG1hdC1vcHRpb24gKm5nRm9yPVwibGV0IGNhbWVyYSBvZiBjYW1lcmFzXCIgW3ZhbHVlXT1cImNhbWVyYS5kZXZpY2VcIj5cblx0XHRcdFx0e3sgY2FtZXJhLmxhYmVsIH19XG5cdFx0XHQ8L21hdC1vcHRpb24+XG5cdFx0PC9tYXQtc2VsZWN0PlxuXHQ8L21hdC1mb3JtLWZpZWxkPlxuPC9kaXY+XG4iXX0=