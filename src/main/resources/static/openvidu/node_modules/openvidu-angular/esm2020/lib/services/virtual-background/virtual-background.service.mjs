import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { EffectType } from '../../models/background-effect.model';
import * as i0 from "@angular/core";
import * as i1 from "../participant/participant.service";
import * as i2 from "../storage/storage.service";
import * as i3 from "../openvidu/openvidu.service";
/**
 * @internal
 */
export class VirtualBackgroundService {
    constructor(participantService, storageService, openviduService) {
        this.participantService = participantService;
        this.storageService = storageService;
        this.openviduService = openviduService;
        this.backgroundSelected = new BehaviorSubject('');
        this.backgrounds = [
            { id: 'no_effect', type: EffectType.NONE, thumbnail: 'block' },
            { id: 'soft_blur', type: EffectType.BLUR, thumbnail: 'blur_on' },
            { id: '1', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-1.jpg', src: 'assets/backgrounds/bg-1.jpg' },
            { id: '2', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-2.jpg', src: 'assets/backgrounds/bg-2.jpg' },
            { id: '3', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-3.jpg', src: 'assets/backgrounds/bg-3.jpg' },
            { id: '4', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-4.jpg', src: 'assets/backgrounds/bg-4.jpg' },
            { id: '19', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-19.jpg', src: 'assets/backgrounds/bg-19.jpg' },
            { id: '5', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-5.jpg', src: 'assets/backgrounds/bg-5.jpg' },
            { id: '6', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-6.jpg', src: 'assets/backgrounds/bg-6.jpg' },
            { id: '7', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-7.jpg', src: 'assets/backgrounds/bg-7.jpg' },
            { id: '8', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-8.jpg', src: 'assets/backgrounds/bg-8.jpg' },
            { id: '9', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-9.jpg', src: 'assets/backgrounds/bg-9.jpg' },
            { id: '10', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-10.jpg', src: 'assets/backgrounds/bg-10.jpg' },
            { id: '11', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-11.jpg', src: 'assets/backgrounds/bg-11.jpg' },
            { id: '12', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-12.jpg', src: 'assets/backgrounds/bg-12.jpg' },
            { id: '13', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-13.jpg', src: 'assets/backgrounds/bg-13.jpg' },
            { id: '14', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-14.jpg', src: 'assets/backgrounds/bg-14.jpg' },
            { id: '15', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-15.jpg', src: 'assets/backgrounds/bg-15.jpg' },
            { id: '16', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-16.jpg', src: 'assets/backgrounds/bg-16.jpg' },
            { id: '17', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-17.jpg', src: 'assets/backgrounds/bg-17.jpg' },
            { id: '18', type: EffectType.IMAGE, thumbnail: 'assets/backgrounds/thumbnails/bg-18.jpg', src: 'assets/backgrounds/bg-18.jpg' }
        ];
        this.backgroundSelectedObs = this.backgroundSelected.asObservable();
    }
    getBackgrounds() {
        return this.backgrounds;
    }
    isBackgroundApplied() {
        const bgSelected = this.backgroundSelected.getValue();
        return !!bgSelected && bgSelected !== 'no_effect';
    }
    async applyBackgroundFromStorage() {
        const bgId = this.storageService.getBackground();
        if (!!bgId) {
            const background = this.backgrounds.find((bg) => bg.id === bgId);
            if (background) {
                this.applyBackground(background);
            }
        }
    }
    async applyBackground(bg) {
        if (bg.id !== this.backgroundSelected.getValue()) {
            const filter = this.participantService.getMyCameraPublisher().stream.filter;
            const isBackgroundSelected = !!filter && filter.type.startsWith('VB:');
            let options = { token: this.openviduService.getWebcamToken(), url: '' };
            if (bg.type === EffectType.IMAGE) {
                options.url = bg.src;
            }
            if (isBackgroundSelected && this.hasSameTypeAsAbove(bg.type)) {
                this.replaceBackground(bg);
            }
            else {
                await this.removeBackground();
                await this.participantService.getMyCameraPublisher().stream.applyFilter(`VB:${bg.type.toLowerCase()}`, options);
            }
            this.storageService.setBackground(bg.id);
            this.backgroundSelected.next(bg.id);
        }
    }
    async removeBackground() {
        if (!!this.isBackgroundApplied()) {
            this.backgroundSelected.next('no_effect');
            await this.participantService.getMyCameraPublisher().stream.removeFilter();
            this.storageService.removeBackground();
        }
    }
    async replaceBackground(effect) {
        await this.participantService.getMyCameraPublisher().stream.filter.execMethod('update', { url: effect.src });
    }
    hasSameTypeAsAbove(type) {
        const oldEffect = this.backgrounds.find((bg) => bg.id === this.backgroundSelected.getValue());
        return oldEffect?.type === type;
    }
}
VirtualBackgroundService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.8", ngImport: i0, type: VirtualBackgroundService, deps: [{ token: i1.ParticipantService }, { token: i2.StorageService }, { token: i3.OpenViduService }], target: i0.ɵɵFactoryTarget.Injectable });
VirtualBackgroundService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.8", ngImport: i0, type: VirtualBackgroundService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.8", ngImport: i0, type: VirtualBackgroundService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.ParticipantService }, { type: i2.StorageService }, { type: i3.OpenViduService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbC1iYWNrZ3JvdW5kLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9vcGVudmlkdS1hbmd1bGFyL3NyYy9saWIvc2VydmljZXMvdmlydHVhbC1iYWNrZ3JvdW5kL3ZpcnR1YWwtYmFja2dyb3VuZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGVBQWUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUNuRCxPQUFPLEVBQW9CLFVBQVUsRUFBRSxNQUFNLHNDQUFzQyxDQUFDOzs7OztBQUtwRjs7R0FFRztBQUlILE1BQU0sT0FBTyx3QkFBd0I7SUEyQnBDLFlBQ1Msa0JBQXNDLEVBQ3RDLGNBQThCLEVBQzlCLGVBQWdDO1FBRmhDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBb0I7UUFDdEMsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLG9CQUFlLEdBQWYsZUFBZSxDQUFpQjtRQTdCekMsdUJBQWtCLEdBQTRCLElBQUksZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRXRFLGdCQUFXLEdBQXVCO1lBQ2pDLEVBQUUsRUFBRSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFO1lBQzlELEVBQUUsRUFBRSxFQUFFLFdBQVcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLElBQUksRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFO1lBQ2hFLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsd0NBQXdDLEVBQUUsR0FBRyxFQUFFLDZCQUE2QixFQUFFO1lBQzVILEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsd0NBQXdDLEVBQUUsR0FBRyxFQUFFLDZCQUE2QixFQUFFO1lBQzVILEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsd0NBQXdDLEVBQUUsR0FBRyxFQUFFLDZCQUE2QixFQUFFO1lBQzVILEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsd0NBQXdDLEVBQUUsR0FBRyxFQUFFLDZCQUE2QixFQUFFO1lBQzVILEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUseUNBQXlDLEVBQUUsR0FBRyxFQUFFLDhCQUE4QixFQUFFO1lBQy9ILEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsd0NBQXdDLEVBQUUsR0FBRyxFQUFFLDZCQUE2QixFQUFFO1lBQzVILEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsd0NBQXdDLEVBQUUsR0FBRyxFQUFFLDZCQUE2QixFQUFFO1lBQzVILEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsd0NBQXdDLEVBQUUsR0FBRyxFQUFFLDZCQUE2QixFQUFFO1lBQzVILEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsd0NBQXdDLEVBQUUsR0FBRyxFQUFFLDZCQUE2QixFQUFFO1lBQzVILEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUsd0NBQXdDLEVBQUUsR0FBRyxFQUFFLDZCQUE2QixFQUFFO1lBQzVILEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUseUNBQXlDLEVBQUUsR0FBRyxFQUFFLDhCQUE4QixFQUFFO1lBQy9ILEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUseUNBQXlDLEVBQUUsR0FBRyxFQUFFLDhCQUE4QixFQUFFO1lBQy9ILEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUseUNBQXlDLEVBQUUsR0FBRyxFQUFFLDhCQUE4QixFQUFFO1lBQy9ILEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUseUNBQXlDLEVBQUUsR0FBRyxFQUFFLDhCQUE4QixFQUFFO1lBQy9ILEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUseUNBQXlDLEVBQUUsR0FBRyxFQUFFLDhCQUE4QixFQUFFO1lBQy9ILEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUseUNBQXlDLEVBQUUsR0FBRyxFQUFFLDhCQUE4QixFQUFFO1lBQy9ILEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUseUNBQXlDLEVBQUUsR0FBRyxFQUFFLDhCQUE4QixFQUFFO1lBQy9ILEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUseUNBQXlDLEVBQUUsR0FBRyxFQUFFLDhCQUE4QixFQUFFO1lBQy9ILEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsVUFBVSxDQUFDLEtBQUssRUFBRSxTQUFTLEVBQUUs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O1FBQ3ZELE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLG9CQUFvQixFQUFFLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQzlHLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxJQUFnQjtRQUMxQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztRQUM5RixPQUFPLFNBQVMsRUFBRSxJQUFJLEtBQUssSUFBSSxDQUFDO0lBQ2pDLENBQUM7O3FIQXpGVyx3QkFBd0I7eUhBQXhCLHdCQUF3QixjQUZ4QixNQUFNOzJGQUVOLHdCQUF3QjtrQkFIcEMsVUFBVTttQkFBQztvQkFDWCxVQUFVLEVBQUUsTUFBTTtpQkFDbEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEJhY2tncm91bmRFZmZlY3QsIEVmZmVjdFR5cGUgfSBmcm9tICcuLi8uLi9tb2RlbHMvYmFja2dyb3VuZC1lZmZlY3QubW9kZWwnO1xuaW1wb3J0IHsgT3BlblZpZHVTZXJ2aWNlIH0gZnJvbSAnLi4vb3BlbnZpZHUvb3BlbnZpZHUuc2VydmljZSc7XG5pbXBvcnQgeyBQYXJ0aWNpcGFudFNlcnZpY2UgfSBmcm9tICcuLi9wYXJ0aWNpcGFudC9wYXJ0aWNpcGFudC5zZXJ2aWNlJztcbmltcG9ydCB7IFN0b3JhZ2VTZXJ2aWNlIH0gZnJvbSAnLi4vc3RvcmFnZS9zdG9yYWdlLnNlcnZpY2UnO1xuXG4vKipcbiAqIEBpbnRlcm5hbFxuICovXG5ASW5qZWN0YWJsZSh7XG5cdHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBWaXJ0dWFsQmFja2dyb3VuZFNlcnZpY2Uge1xuXHRiYWNrZ3JvdW5kU2VsZWN0ZWQgPSA8QmVoYXZpb3JTdWJqZWN0PHN0cmluZz4+bmV3IEJlaGF2aW9yU3ViamVjdCgnJyk7XG5cdGJhY2tncm91bmRTZWxlY3RlZE9iczogT2JzZXJ2YWJsZTxzdHJpbmc+O1xuXHRiYWNrZ3JvdW5kczogQmFja2dyb3VuZEVmZmVjdFtdID0gW1xuXHRcdHsgaWQ6ICdub19lZmZlY3QnLCB0eXBlOiBFZmZlY3RUeXBlLk5PTkUsIHRodW1ibmFpbDogJ2Jsb2NrJyB9LFxuXHRcdHsgaWQ6ICdzb2Z0X2JsdXInLCB0eXBlOiBFZmZlY3RUeXBlLkJMVVIsIHRodW1ibmFpbDogJ2JsdXJfb24nIH0sXG5cdFx0eyBpZDogJzEnLCB0eXBlOiBFZmZlY3RUeXBlLklNQUdFLCB0aHVtYm5haWw6ICdhc3NldHMvYmFja2dyb3VuZHMvdGh1bWJuYWlscy9iZy0xLmpwZycsIHNyYzogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy9iZy0xLmpwZycgfSxcblx0XHR7IGlkOiAnMicsIHR5cGU6IEVmZmVjdFR5cGUuSU1BR0UsIHRodW1ibmFpbDogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy90aHVtYm5haWxzL2JnLTIuanBnJywgc3JjOiAnYXNzZXRzL2JhY2tncm91bmRzL2JnLTIuanBnJyB9LFxuXHRcdHsgaWQ6ICczJywgdHlwZTogRWZmZWN0VHlwZS5JTUFHRSwgdGh1bWJuYWlsOiAnYXNzZXRzL2JhY2tncm91bmRzL3RodW1ibmFpbHMvYmctMy5qcGcnLCBzcmM6ICdhc3NldHMvYmFja2dyb3VuZHMvYmctMy5qcGcnIH0sXG5cdFx0eyBpZDogJzQnLCB0eXBlOiBFZmZlY3RUeXBlLklNQUdFLCB0aHVtYm5haWw6ICdhc3NldHMvYmFja2dyb3VuZHMvdGh1bWJuYWlscy9iZy00LmpwZycsIHNyYzogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy9iZy00LmpwZycgfSxcblx0XHR7IGlkOiAnMTknLCB0eXBlOiBFZmZlY3RUeXBlLklNQUdFLCB0aHVtYm5haWw6ICdhc3NldHMvYmFja2dyb3VuZHMvdGh1bWJuYWlscy9iZy0xOS5qcGcnLCBzcmM6ICdhc3NldHMvYmFja2dyb3VuZHMvYmctMTkuanBnJyB9LFxuXHRcdHsgaWQ6ICc1JywgdHlwZTogRWZmZWN0VHlwZS5JTUFHRSwgdGh1bWJuYWlsOiAnYXNzZXRzL2JhY2tncm91bmRzL3RodW1ibmFpbHMvYmctNS5qcGcnLCBzcmM6ICdhc3NldHMvYmFja2dyb3VuZHMvYmctNS5qcGcnIH0sXG5cdFx0eyBpZDogJzYnLCB0eXBlOiBFZmZlY3RUeXBlLklNQUdFLCB0aHVtYm5haWw6ICdhc3NldHMvYmFja2dyb3VuZHMvdGh1bWJuYWlscy9iZy02LmpwZycsIHNyYzogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy9iZy02LmpwZycgfSxcblx0XHR7IGlkOiAnNycsIHR5cGU6IEVmZmVjdFR5cGUuSU1BR0UsIHRodW1ibmFpbDogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy90aHVtYm5haWxzL2JnLTcuanBnJywgc3JjOiAnYXNzZXRzL2JhY2tncm91bmRzL2JnLTcuanBnJyB9LFxuXHRcdHsgaWQ6ICc4JywgdHlwZTogRWZmZWN0VHlwZS5JTUFHRSwgdGh1bWJuYWlsOiAnYXNzZXRzL2JhY2tncm91bmRzL3RodW1ibmFpbHMvYmctOC5qcGcnLCBzcmM6ICdhc3NldHMvYmFja2dyb3VuZHMvYmctOC5qcGcnIH0sXG5cdFx0eyBpZDogJzknLCB0eXBlOiBFZmZlY3RUeXBlLklNQUdFLCB0aHVtYm5haWw6ICdhc3NldHMvYmFja2dyb3VuZHMvdGh1bWJuYWlscy9iZy05LmpwZycsIHNyYzogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy9iZy05LmpwZycgfSxcblx0XHR7IGlkOiAnMTAnLCB0eXBlOiBFZmZlY3RUeXBlLklNQUdFLCB0aHVtYm5haWw6ICdhc3NldHMvYmFja2dyb3VuZHMvdGh1bWJuYWlscy9iZy0xMC5qcGcnLCBzcmM6ICdhc3NldHMvYmFja2dyb3VuZHMvYmctMTAuanBnJyB9LFxuXHRcdHsgaWQ6ICcxMScsIHR5cGU6IEVmZmVjdFR5cGUuSU1BR0UsIHRodW1ibmFpbDogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy90aHVtYm5haWxzL2JnLTExLmpwZycsIHNyYzogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy9iZy0xMS5qcGcnIH0sXG5cdFx0eyBpZDogJzEyJywgdHlwZTogRWZmZWN0VHlwZS5JTUFHRSwgdGh1bWJuYWlsOiAnYXNzZXRzL2JhY2tncm91bmRzL3RodW1ibmFpbHMvYmctMTIuanBnJywgc3JjOiAnYXNzZXRzL2JhY2tncm91bmRzL2JnLTEyLmpwZycgfSxcblx0XHR7IGlkOiAnMTMnLCB0eXBlOiBFZmZlY3RUeXBlLklNQUdFLCB0aHVtYm5haWw6ICdhc3NldHMvYmFja2dyb3VuZHMvdGh1bWJuYWlscy9iZy0xMy5qcGcnLCBzcmM6ICdhc3NldHMvYmFja2dyb3VuZHMvYmctMTMuanBnJyB9LFxuXHRcdHsgaWQ6ICcxNCcsIHR5cGU6IEVmZmVjdFR5cGUuSU1BR0UsIHRodW1ibmFpbDogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy90aHVtYm5haWxzL2JnLTE0LmpwZycsIHNyYzogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy9iZy0xNC5qcGcnIH0sXG5cdFx0eyBpZDogJzE1JywgdHlwZTogRWZmZWN0VHlwZS5JTUFHRSwgdGh1bWJuYWlsOiAnYXNzZXRzL2JhY2tncm91bmRzL3RodW1ibmFpbHMvYmctMTUuanBnJywgc3JjOiAnYXNzZXRzL2JhY2tncm91bmRzL2JnLTE1LmpwZycgfSxcblx0XHR7IGlkOiAnMTYnLCB0eXBlOiBFZmZlY3RUeXBlLklNQUdFLCB0aHVtYm5haWw6ICdhc3NldHMvYmFja2dyb3VuZHMvdGh1bWJuYWlscy9iZy0xNi5qcGcnLCBzcmM6ICdhc3NldHMvYmFja2dyb3VuZHMvYmctMTYuanBnJyB9LFxuXHRcdHsgaWQ6ICcxNycsIHR5cGU6IEVmZmVjdFR5cGUuSU1BR0UsIHRodW1ibmFpbDogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy90aHVtYm5haWxzL2JnLTE3LmpwZycsIHNyYzogJ2Fzc2V0cy9iYWNrZ3JvdW5kcy9iZy0xNy5qcGcnIH0sXG5cdFx0eyBpZDogJzE4JywgdHlwZTogRWZmZWN0VHlwZS5JTUFHRSwgdGh1bWJuYWlsOiAnYXNzZXRzL2JhY2tncm91bmRzL3RodW1ibmFpbHMvYmctMTguanBnJywgc3JjOiAnYXNzZXRzL2JhY2tncm91bmRzL2JnLTE4LmpwZycgfVxuXHRdO1xuXG5cdGNvbnN0cnVjdG9yKFxuXHRcdHByaXZhdGUgcGFydGljaXBhbnRTZXJ2aWNlOiBQYXJ0aWNpcGFudFNlcnZpY2UsXG5cdFx0cHJpdmF0ZSBzdG9yYWdlU2VydmljZTogU3RvcmFnZVNlcnZpY2UsXG5cdFx0cHJpdmF0ZSBvcGVudmlkdVNlcnZpY2U6IE9wZW5WaWR1U2VydmljZVxuXHQpIHtcblx0XHR0aGlzLmJhY2tncm91bmRTZWxlY3RlZE9icyA9IHRoaXMuYmFja2dyb3VuZFNlbGVjdGVkLmFzT2JzZXJ2YWJsZSgpO1xuXHR9XG5cblx0Z2V0QmFja2dyb3VuZHMoKTogYW55W10ge1xuXHRcdHJldHVybiB0aGlzLmJhY2tncm91bmRzO1xuXHR9XG5cblx0aXNCYWNrZ3JvdW5kQXBwbGllZCgpOiBib29sZWFuIHtcblx0XHRjb25zdCBiZ1NlbGVjdGVkID0gdGhpcy5iYWNrZ3JvdW5kU2VsZWN0ZWQuZ2V0VmFsdWUoKTtcblx0XHRyZXR1cm4gISFiZ1NlbGVjdGVkICYmIGJnU2VsZWN0ZWQgIT09ICdub19lZmZlY3QnO1xuXHR9XG5cblx0YXN5bmMgYXBwbHlCYWNrZ3JvdW5kRnJvbVN0b3JhZ2UoKSB7XG5cdFx0Y29uc3QgYmdJZCA9IHRoaXMuc3RvcmFnZVNlcnZpY2UuZ2V0QmFja2dyb3VuZCgpO1xuXHRcdGlmICghIWJnSWQpIHtcblx0XHRcdGNvbnN0IGJhY2tncm91bmQgPSB0aGlzLmJhY2tncm91bmRzLmZpbmQoKGJnKSA9PiBiZy5pZCA9PT0gYmdJZCk7XG5cdFx0XHRpZiAoYmFja2dyb3VuZCkge1xuXHRcdFx0XHR0aGlzLmFwcGx5QmFja2dyb3VuZChiYWNrZ3JvdW5kKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRhc3luYyBhcHBseUJhY2tncm91bmQoYmc6IEJhY2tncm91bmRFZmZlY3QpIHtcblx0XHRpZiAoYmcuaWQgIT09IHRoaXMuYmFja2dyb3VuZFNlbGVjdGVkLmdldFZhbHVlKCkpIHtcblx0XHRcdGNvbnN0IGZpbHRlciA9IHRoaXMucGFydGljaXBhbnRTZXJ2aWNlLmdldE15Q2FtZXJhUHVibGlzaGVyKCkuc3RyZWFtLmZpbHRlcjtcblx0XHRcdGNvbnN0IGlzQmFja2dyb3VuZFNlbGVjdGVkID0gISFmaWx0ZXIgJiYgZmlsdGVyLnR5cGUuc3RhcnRzV2l0aCgnVkI6Jyk7XG5cdFx0XHRsZXQgb3B0aW9ucyA9IHsgdG9rZW46IHRoaXMub3BlbnZpZHVTZXJ2aWNlLmdldFdlYmNhbVRva2VuKCksIHVybDogJycgfTtcblx0XHRcdGlmIChiZy50eXBlID09PSBFZmZlY3RUeXBlLklNQUdFKSB7XG5cdFx0XHRcdG9wdGlvbnMudXJsID0gYmcuc3JjO1xuXHRcdFx0fVxuXG5cdFx0XHRpZiAoaXNCYWNrZ3JvdW5kU2VsZWN0ZWQgJiYgdGhpcy5oYXNTYW1lVHlwZUFzQWJvdmUoYmcudHlwZSkpIHtcblx0XHRcdFx0dGhpcy5yZXBsYWNlQmFja2dyb3VuZChiZyk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRhd2FpdCB0aGlzLnJlbW92ZUJhY2tncm91bmQoKTtcblx0XHRcdFx0YXdhaXQgdGhpcy5wYXJ0aWNpcGFudFNlcnZpY2UuZ2V0TXlDYW1lcmFQdWJsaXNoZXIoKS5zdHJlYW0uYXBwbHlGaWx0ZXIoYFZCOiR7YmcudHlwZS50b0xvd2VyQ2FzZSgpfWAsIG9wdGlvbnMpO1xuXHRcdFx0fVxuXHRcdFx0dGhpcy5zdG9yYWdlU2VydmljZS5zZXRCYWNrZ3JvdW5kKGJnLmlkKTtcblx0XHRcdHRoaXMuYmFja2dyb3VuZFNlbGVjdGVkLm5leHQoYmcuaWQpO1xuXHRcdH1cblx0fVxuXG5cdGFzeW5jIHJlbW92ZUJhY2tncm91bmQoKSB7XG5cdFx0aWYgKCEhdGhpcy5pc0JhY2tncm91bmRBcHBsaWVkKCkpIHtcblx0XHRcdHRoaXMuYmFja2dyb3VuZFNlbGVjdGVkLm5leHQoJ25vX2VmZmVjdCcpO1xuXHRcdFx0YXdhaXQgdGhpcy5wYXJ0aWNpcGFudFNlcnZpY2UuZ2V0TXlDYW1lcmFQdWJsaXNoZXIoKS5zdHJlYW0ucmVtb3ZlRmlsdGVyKCk7XG5cdFx0XHR0aGlzLnN0b3JhZ2VTZXJ2aWNlLnJlbW92ZUJhY2tncm91bmQoKTtcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIHJlcGxhY2VCYWNrZ3JvdW5kKGVmZmVjdDogQmFja2dyb3VuZEVmZmVjdCkge1xuXHRcdGF3YWl0IHRoaXMucGFydGljaXBhbnRTZXJ2aWNlLmdldE15Q2FtZXJhUHVibGlzaGVyKCkuc3RyZWFtLmZpbHRlci5leGVjTWV0aG9kKCd1cGRhdGUnLCB7IHVybDogZWZmZWN0LnNyYyB9KTtcblx0fVxuXG5cdHByaXZhdGUgaGFzU2FtZVR5cGVBc0Fib3ZlKHR5cGU6IEVmZmVjdFR5cGUpOiBib29sZWFuIHtcblx0XHRjb25zdCBvbGRFZmZlY3QgPSB0aGlzLmJhY2tncm91bmRzLmZpbmQoKGJnKSA9PiBiZy5pZCA9PT0gdGhpcy5iYWNrZ3JvdW5kU2VsZWN0ZWQuZ2V0VmFsdWUoKSk7XG5cdFx0cmV0dXJuIG9sZEVmZmVjdD8udHlwZSA9PT0gdHlwZTtcblx0fVxufVxuIl19